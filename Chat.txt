using MDUA.DataAccess.Interface;
using MDUA.Entities;
using MDUA.Framework;
using MDUA.Framework.DataAccess;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using Microsoft.Extensions.Configuration;
using static MDUA.Entities.ChatSession;

namespace MDUA.DataAccess
{
    public partial class ChatDataAccess : BaseDataAccess, IChatDataAccess
    {
        public ChatDataAccess(IConfiguration configuration) : base(configuration)
        {
        }

        // -----------------------------------------------------------
        // 1. SESSION MANAGEMENT
        // -----------------------------------------------------------

        public ChatSession CreateOrGetSession(ChatSession session)
        {
            // First, try to find if the session already exists
            ChatSession existingSession = null;

            if (session.UserLoginId.HasValue && session.UserLoginId > 0)
                existingSession = GetSessionByUserId(session.UserLoginId.Value);
            else if (session.SessionGuid != Guid.Empty)
                existingSession = GetSessionByGuid(session.SessionGuid);

            if (existingSession != null)
                return existingSession;

            // If not exists, create new using the SP you provided
            using (SqlCommand cmd = GetSPCommand("InsertChatSession"))
            {
                // Output Parameter for ID
                SqlParameter pId = pInt32Out("Id");
                AddParameter(cmd, pId);

                // Input Parameters
                AddParameter(cmd, pGuid("SessionGuid", session.SessionGuid));
                AddParameter(cmd, pInt32("UserLoginId", session.UserLoginId));
                AddParameter(cmd, pNVarChar("GuestName", session.GuestName));
                AddParameter(cmd, pNVarChar("Status", string.IsNullOrEmpty(session.Status) ? "New" : session.Status));
                AddParameter(cmd, pDateTime("StartedAt", DateTime.UtcNow));
                AddParameter(cmd, pDateTime("LastMessageAt", DateTime.UtcNow));
                AddParameter(cmd, pBool("IsActive", true));

                // Execute
                ExecuteCommand(cmd);

                // Retrieve the new ID
                session.Id = (int)pId.Value;
            }

            return session;
        }

        public ChatSession GetSessionByGuid(Guid sessionGuid)
        {
            string query = "SELECT * FROM ChatSession WHERE SessionGuid = @SessionGuid";
            using (SqlCommand cmd = GetSQLCommand(query))
            {
                AddParameter(cmd, pGuid("SessionGuid", sessionGuid));
                return GetObject(cmd); // Assumes GetObject is a helper in BaseDataAccess or we implement filler manually
            }
        }

        public ChatSession GetSessionByUserId(int userId)
        {
            string query = "SELECT TOP 1 * FROM ChatSession WHERE UserLoginId = @UserId AND IsActive = 1 ORDER BY LastMessageAt DESC";
            using (SqlCommand cmd = GetSQLCommand(query))
            {
                AddParameter(cmd, pInt32("UserId", userId));
                return GetObject(cmd);
            }
        }

        // In MDUA.DataAccess/ChatDataAccess.cs

        public List<ChatSession> GetActiveSessions()
        {
            // Updated Query: Includes a subquery to count unread messages from the Guest
            string query = @"
        SELECT 
            s.*,
            (SELECT COUNT(*) FROM ChatMessage m 
             WHERE m.ChatSessionId = s.Id 
             AND m.IsRead = 0 
             AND m.IsFromAdmin = 0) AS UnreadCount
        FROM ChatSession s 
        WHERE s.IsActive = 1 
        AND s.Status != 'Closed' 
        ORDER BY 
            CASE WHEN (SELECT COUNT(*) FROM ChatMessage m WHERE m.ChatSessionId = s.Id AND m.IsRead = 0 AND m.IsFromAdmin = 0) > 0 THEN 0 ELSE 1 END, 
            s.LastMessageAt DESC";

            using (SqlCommand cmd = GetSQLCommand(query))
            {
                // We use a custom filler here because we added the extra 'UnreadCount' column
                SqlDataReader reader;
                SelectRecords(cmd, out reader);

                var list = new List<ChatSession>();
                using (reader)
                {
                    while (reader.Read())
                    {
                        var session = new ChatSession();
                        // Call your existing helper
                        FillChatSession(session, reader);

                        // Manually fill the new property
                        session.UnreadCount = reader.GetInt32(reader.GetOrdinal("UnreadCount"));

                        list.Add(session);
                    }
                }
                return list;
            }
        }

        // -----------------------------------------------------------
        // 2. MESSAGE MANAGEMENT
        // -----------------------------------------------------------

        public long SaveMessage(ChatMessage message)
        {
            string query = @"
                INSERT INTO ChatMessage 
                (ChatSessionId, SenderId, SenderName, MessageText, IsFromAdmin, IsRead, SentAt)
                VALUES 
                (@ChatSessionId, @SenderId, @SenderName, @MessageText, @IsFromAdmin, 0, GETDATE());
                
                -- Update the parent session's timestamp AND GuestName
              UPDATE ChatSession 
SET 
    LastMessageAt = GETDATE(),
    GuestName = CASE 
        WHEN @IsFromAdmin = 0 
             AND @SenderName IS NOT NULL 
             AND LEN(@SenderName) > 0 
        THEN @SenderName 
        ELSE GuestName 
    END
WHERE Id = @ChatSessionId;


                SELECT CAST(SCOPE_IDENTITY() as bigint);";

            using (SqlCommand cmd = GetSQLCommand(query))
            {
                AddParameter(cmd, pInt32("ChatSessionId", message.ChatSessionId));
                AddParameter(cmd, pInt32("SenderId", message.SenderId));
                AddParameter(cmd, pNVarChar("SenderName", message.SenderName));
                AddParameter(cmd, pNVarChar("MessageText", message.MessageText));
                AddParameter(cmd, pBool("IsFromAdmin", message.IsFromAdmin));

                return (long)SelectScaler(cmd);
            }
        }
        public List<ChatMessage> GetMessagesBySessionId(int sessionId)
        {
            string query = "SELECT * FROM ChatMessage WHERE ChatSessionId = @ChatSessionId ORDER BY SentAt ASC";
            using (SqlCommand cmd = GetSQLCommand(query))
            {
                AddParameter(cmd, pInt32("ChatSessionId", sessionId));

                // Manual List Filling to ensure independence if framework helpers aren't generic enough
                List<ChatMessage> list = new List<ChatMessage>();
                SqlDataReader reader;
                SelectRecords(cmd, out reader); // Uses  BaseDataAccess method

                using (reader)
                {
                    while (reader.Read())
                    {
                        var msg = new ChatMessage
                        {
                            Id = reader.GetInt32(reader.GetOrdinal("Id")),
                            ChatSessionId = reader.GetInt32(reader.GetOrdinal("ChatSessionId")),
                            SenderName = reader["SenderName"].ToString(),
                            MessageText = reader["MessageText"].ToString(),
                            IsFromAdmin = reader.GetBoolean(reader.GetOrdinal("IsFromAdmin")),
                            IsRead = reader.GetBoolean(reader.GetOrdinal("IsRead")),
                            SentAt = reader.GetDateTime(reader.GetOrdinal("SentAt"))
                        };

                        if (!reader.IsDBNull(reader.GetOrdinal("SenderId")))
                            msg.SenderId = reader.GetInt32(reader.GetOrdinal("SenderId"));

                        list.Add(msg);
                    }
                }
                return list;
            }
        }

        public void MarkMessagesAsRead(int sessionId, bool messagesFromAdmin)
        {
            // If I am Admin, I want to mark User messages as read (IsFromAdmin = 0)
            // If I am User, I want to mark Admin messages as read (IsFromAdmin = 1)

            string query = @"
                UPDATE ChatMessage 
                SET IsRead = 1 
                WHERE ChatSessionId = @SessionId 
                AND IsFromAdmin = @TargetIsAdmin 
                AND IsRead = 0";

            using (SqlCommand cmd = GetSQLCommand(query))
            {
                AddParameter(cmd, pInt32("SessionId", sessionId));
                AddParameter(cmd, pBool("TargetIsAdmin", messagesFromAdmin));
                ExecuteCommand(cmd);
            }
        }

        // -----------------------------------------------------------
        // 3. HELPER METHODS (MAPPING)
        // -----------------------------------------------------------

        /// <summary>
        /// Helper to map a single ChatSession from a DataReader (Matches your pattern in New Text Document.txt)
        /// </summary>
        private ChatSession GetObject(SqlCommand cmd)
        {
            SqlDataReader reader;
            SelectRecord(cmd, out reader); // Assumes BaseDataAccess has SelectRecord (singular)

            using (reader)
            {
                if (reader.Read())
                {
                    var session = new ChatSession();
                    FillChatSession(session, reader);
                    return session;
                }
            }
            return null;
        }
        public ChatSession GetSessionById(int sessionId)
        {
            string query = "SELECT * FROM ChatSession WHERE Id = @Id";
            using (SqlCommand cmd = GetSQLCommand(query))
            {
                AddParameter(cmd, pInt32("Id", sessionId));
                // Reuse the helper in the class
                return GetObject(cmd);
            }
        }
        private List<ChatSession> GetList(SqlCommand cmd)
        {
            SqlDataReader reader;
            SelectRecords(cmd, out reader);

            var list = new List<ChatSession>();
            using (reader)
            {
                while (reader.Read())
                {
                    var session = new ChatSession();
                    FillChatSession(session, reader);
                    list.Add(session);
                }
            }
            return list;
        }


        public void UpdateSession(ChatSession session)
        {
            string query = @"
        UPDATE ChatSession 
        SET Status = @Status, 
            LastMessageAt = @LastMessageAt 
        WHERE Id = @Id";

            using (SqlCommand cmd = GetSQLCommand(query))
            {
                AddParameter(cmd, pInt32("Id", session.Id));
                AddParameter(cmd, pNVarChar("Status", session.Status));
                AddParameter(cmd, pDateTime("LastMessageAt", session.LastMessageAt));
                ExecuteCommand(cmd);
            }
        }
        private void FillChatSession(ChatSession session, SqlDataReader reader)
        {
            session.Id = reader.GetInt32(reader.GetOrdinal("Id"));
            session.SessionGuid = reader.GetGuid(reader.GetOrdinal("SessionGuid"));
            session.Status = reader["Status"].ToString();
            session.StartedAt = reader.GetDateTime(reader.GetOrdinal("StartedAt"));
            session.LastMessageAt = reader.GetDateTime(reader.GetOrdinal("LastMessageAt"));
            session.IsActive = reader.GetBoolean(reader.GetOrdinal("IsActive"));
            session.GuestName = reader["GuestName"] as string;

            if (!reader.IsDBNull(reader.GetOrdinal("UserLoginId")))
                session.UserLoginId = reader.GetInt32(reader.GetOrdinal("UserLoginId"));
        }
    }
}
________________________________________________________________________
using MDUA.DataAccess.Interface;
using MDUA.Entities;
using MDUA.Facade.Interface;
using System;
using System.Collections.Generic;

namespace MDUA.Facade
{
    public class ChatFacade : IChatFacade
    {
        private readonly IChatDataAccess _chatDataAccess;

        public ChatFacade(IChatDataAccess chatDataAccess)
        {
            _chatDataAccess = chatDataAccess;
        }

        #region Session Management

        public ChatSession InitGuestSession(Guid sessionGuid)
        {
            if (sessionGuid == Guid.Empty)
                throw new ArgumentException("Session GUID cannot be empty for guests.");

            var session = new ChatSession
            {
                SessionGuid = sessionGuid,
                UserLoginId = null,
                GuestName = "Guest-" + sessionGuid.ToString().Substring(0, 4), // Friendly Name
                Status = "New",
                IsActive = true
            };

            return _chatDataAccess.CreateOrGetSession(session);
        }

        public ChatSession InitUserSession(int userId, string userName)
        {
            if (userId <= 0)
                throw new ArgumentException("Invalid User ID.");

            var session = new ChatSession
            {
                SessionGuid = Guid.NewGuid(),
                UserLoginId = userId,
                GuestName = userName,
                Status = "New",
                IsActive = true
            };

            return _chatDataAccess.CreateOrGetSession(session);
        }

        public List<ChatSession> GetActiveSessionsForAdmin()
        {
            return _chatDataAccess.GetActiveSessions();
        }

        public ChatSession GetSessionByGuid(Guid sessionGuid)
        {
            return _chatDataAccess.GetSessionByGuid(sessionGuid);
        }
        public ChatSession GetSessionById(int sessionId)
        {
            return _chatDataAccess.GetSessionById(sessionId);
        }

        #endregion

        #region Message Handling

        public long SendMessage(ChatMessage message)
        {
            if (message == null)
                throw new ArgumentNullException(nameof(message));

            if (string.IsNullOrWhiteSpace(message.MessageText))
                throw new ArgumentException("Message text cannot be empty.");

            // 1. Validation
            if (message.ChatSessionId <= 0)
            {
                throw new InvalidOperationException("Cannot send message without a valid Chat Session ID.");
            }

            // 2. Set Defaults if missing
            if (message.SentAt == DateTime.MinValue)
                message.SentAt = DateTime.UtcNow;

            // 3. Save via Data Access
            return _chatDataAccess.SaveMessage(message);
        }
        public void UpdateSessionStatus(int sessionId, string newStatus)
        {
            var session = _chatDataAccess.GetSessionById(sessionId);
            if (session != null)
            {
                session.Status = newStatus;
                session.LastMessageAt = DateTime.UtcNow;
                _chatDataAccess.UpdateSession(session);
            }
        }
        public List<ChatMessage> GetChatHistory(int sessionId)
        {
            return _chatDataAccess.GetMessagesBySessionId(sessionId);
        }

        public void MarkMessagesAsRead(int sessionId, bool readerIsAdmin)
        {
            // Logic: If Admin reads, we mark 'Customer' messages as read.
            // If Customer reads, we mark 'Admin/Bot' messages as read.

            // Param expected by DB: "Which messages should be marked read?"
            // If Reader=Admin, update messages where IsFromAdmin = false
            bool targetIsAdminMessages = !readerIsAdmin;

            _chatDataAccess.MarkMessagesAsRead(sessionId, targetIsAdminMessages);
        }

        #endregion

        public void Dispose()
        {
            _chatDataAccess?.Dispose();
        }
    }
}
---------------------------------------------------------------------------------------
using MDUA.Entities;
using MDUA.Facade.Interface;
using MDUA.Web.UI.Hubs; // Ensure this namespace matches your Hub location
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.SignalR;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace MDUA.Web.UI.Controllers
{
    [Authorize]
    public class ChatController : BaseController
    {
        private readonly IChatFacade _chatFacade;
        private readonly IAiChatService _aiChatService;
        private readonly IHubContext<SupportHub> _hubContext;

        public ChatController(
            IChatFacade chatFacade,
            IAiChatService aiChatService,
            IHubContext<SupportHub> hubContext)
        {
            _chatFacade = chatFacade;
            _aiChatService = aiChatService;
            _hubContext = hubContext;
        }

        // ====================================================================
        //  REAL-WORLD MESSAGE HANDLING (User -> DB -> SignalR -> AI -> DB -> SignalR)
        // ====================================================================



        // ====================================================================
        //  EXISTING GET METHODS (Cleaned & Optimized)
        // ====================================================================

        [HttpGet]
        [Route("chat/guest-history")]
        [AllowAnonymous]
        public IActionResult GetGuestHistory(string sessionGuid)
        {
            if (!Guid.TryParse(sessionGuid, out Guid guid)) return BadRequest();

            // 1. Find the session
            var session = _chatFacade.GetSessionByGuid(guid);

            // 2. Graceful fallback for new users
            if (session == null)
            {
                return Ok(new List<object>());
            }

            // 3. Get messages
            var history = _chatFacade.GetChatHistory(session.Id);
            return Json(history);
        }

        [HttpGet]
        [Route("chat/active-sessions")]
        public IActionResult GetActiveSessions()
        {
            if (!HasPermission("Chat.View")) return Unauthorized();

            var sessions = _chatFacade.GetActiveSessionsForAdmin();
            return Json(sessions);
        }
        // üÜï HELPER: Save & Send Bot Message
        private async Task SendBotReply(ChatSession session, string messageText)
        {
            // 1. Create the message object
            var botMessage = new ChatMessage
            {
                ChatSessionId = session.Id,
                SenderName = "MDUA Assistant", // Or "System"
                SenderType = "Bot",
                IsFromAdmin = true,
                MessageText = messageText,
                SentAt = DateTime.UtcNow,
                IsRead = true
            };

            // 2. Save to Database
            _chatFacade.SendMessage(botMessage);

            // 3. Send to Client via SignalR
            await _hubContext.Clients
                .Group(session.SessionGuid.ToString().ToLower())
                .SendAsync("ReceiveReply",
                    botMessage.SenderName,
                    botMessage.MessageText);
        }

        [HttpPost]
        [Route("chat/send")]
        [AllowAnonymous]
        public async Task<IActionResult> SendMessage([FromBody] ChatMessageRequest request)
        {
            if (request == null || string.IsNullOrWhiteSpace(request.MessageText))
                return BadRequest("Invalid message.");

            try
            {
                // 1. Resolve Session
                ChatSession session = null;

                if (!string.IsNullOrEmpty(request.SessionGuid) && Guid.TryParse(request.SessionGuid, out Guid guid))
                {
                    session = _chatFacade.InitGuestSession(guid);
                }
                else if (request.ChatSessionId > 0)
                {
                    session = _chatFacade.GetSessionById(request.ChatSessionId);
                }

                if (session == null)
                    return BadRequest("Invalid session.");

                // 2. Create User Message
                var message = new ChatMessage
                {
                    ChatSessionId = session.Id,
                    SenderName = request.SenderName ?? "Guest",
                    MessageText = request.MessageText,
                    IsFromAdmin = false,
                    IsRead = false,
                    SenderType = "Customer",
                    SentAt = DateTime.UtcNow
                };

                // 3. Save User Message
                _chatFacade.SendMessage(message);

                // 4. Broadcast to Admins
                await _hubContext.Clients.Group("Admins").SendAsync(
                    "ReceiveMessage",
                    message.SenderName,
                    message.MessageText,
                    session.SessionGuid.ToString().ToLower());

                // 5. AI BOT LOGIC
                if (session.Status == "New" || session.Status == "BotActive")
                {
                    if (ContainsHandoffKeyword(request.MessageText))
                    {
                        await TransferToHuman(session, "Customer requested human agent");

                        await SendBotReply(
                            session,
                            "üëã I've notified a support agent. Please hold on ‚Äî a human will join shortly."
                        );

                        return Ok(new { success = true, handedOff = true });
                    }

                    var history = _chatFacade.GetChatHistory(session.Id)
                                             .OrderByDescending(m => m.SentAt)
                                             .Take(10)
                                             .OrderBy(m => m.SentAt)
                                             .Select(m => $"{m.SenderName}: {m.MessageText}")
                                             .ToList();

                    string aiResponse = await _aiChatService.GetResponseAsync(
                        request.MessageText,
                        history
                    );

                    if (ContainsHandoffTrigger(aiResponse))
                    {
                        await TransferToHuman(session, "AI unable to assist");
                    }

                    if (session.Status == "New")
                    {
                        session.Status = "BotActive";
                        _chatFacade.UpdateSessionStatus(session.Id, "BotActive");
                    }

                    // Use the helper method
                    await SendBotReply(session, aiResponse);



                }






                return Ok(new { success = true });
            }
            catch (Exception ex)
            {
                return StatusCode(500, "Error: " + ex.Message);
            }
        }

        // üÜï HUMAN HANDOFF LOGIC
        private async Task TransferToHuman(ChatSession session, string reason)
        {
            // 1. Update session status
            session.Status = "Assigned"; // This stops the bot from replying
                                         // Note: You'll need to add an Update method to ChatFacade if not present
            _chatFacade.UpdateSessionStatus(session.Id, "Assigned");

            // 2. Notify admins with URGENT flag
            string clientGroup = session.SessionGuid.ToString().ToLower();
            await _hubContext.Clients.Group("Admins").SendAsync(
                "ReceiveUrgentHandoff",
                session.GuestName,
                reason,
                clientGroup);

            // 3. Send system message to customer
            await _hubContext.Clients.Group(clientGroup).SendAsync(
                "ReceiveSystemMessage",
                "üîî A support agent will join shortly. Please wait...");
        }

        // üîç Check if user wants human
        private bool ContainsHandoffKeyword(string message)
        {
            if (string.IsNullOrWhiteSpace(message))
                return false;

            message = message.ToLower();

            string[] keywords =
            {
        "human",
        "agent",
        "admin",
        "support",
        "representative",
        "someone there",
        "anyone there",
        "real person",
        "talk to someone",
        "connect me",
        "can a human",
        "handover",
        "hand over"
    };

            return keywords.Any(k => message.Contains(k));
        }

        // üîç Check if AI triggered handoff
        private bool ContainsHandoffTrigger(string aiResponse)
        {
            var triggers = new[] {
                "support team", "human agent", "connect you"
            };

            return triggers.Any(t => aiResponse.ToLower().Contains(t));
        }
        // üÜï Request Model
        public class ChatMessageRequest
        {
            public int ChatSessionId { get; set; }
            public string SessionGuid { get; set; }
            public string SenderName { get; set; }
            public string MessageText { get; set; }
        }

        [HttpGet]
        [Route("chat/history")]
        public IActionResult GetHistory(int sessionId)
        {
            if (!HasPermission("Chat.View")) return Unauthorized();

            var history = _chatFacade.GetChatHistory(sessionId);

            // Mark as read immediately when Admin loads history
            bool isAdmin = true;
            _chatFacade.MarkMessagesAsRead(sessionId, isAdmin);

            return Json(history);
        }
    }
}
------------------------------------------------------------------------------
using MDUA.Facade.Interface;
using Microsoft.Extensions.Configuration;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Text;
using System.Threading.Tasks;

namespace MDUA.Web.UI.Services
{
    public class SmartGeminiChatService : IAiChatService
    {
        private readonly string _apiKey;
        private readonly HttpClient _httpClient;
        private readonly IProductFacade _productFacade;
        private readonly IOrderFacade _orderFacade;
        private readonly IChatFacade _chatFacade;

        private const string ModelUrl ="https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";
        public SmartGeminiChatService(
            IConfiguration config,
            HttpClient httpClient,
            IProductFacade productFacade,
            IOrderFacade orderFacade,
            IChatFacade chatFacade)
        {
            _httpClient = httpClient;
            _productFacade = productFacade;
            _orderFacade = orderFacade;
            _chatFacade = chatFacade;

            // Inside SmartGeminiChatService constructor
            _apiKey = config["GEMINI_API_KEY"];

            // ADD THIS CLEANUP:
            if (!string.IsNullOrEmpty(_apiKey))
                _apiKey = _apiKey.Trim();

            if (string.IsNullOrEmpty(_apiKey))
                throw new Exception("Gemini API Key is missing.");
        }

        public async Task<string> GetResponseAsync(string userMessage, List<string> history)
        {
            var sb = new StringBuilder();

            // üî• SYSTEM PROMPT with Instructions
            sb.AppendLine(@"You are MDUA Assistant, a helpful AI for MDUA - an e-commerce platform in Bangladesh.

 CAPABILITIES:
‚úÖ Search and recommend products
‚úÖ Check stock availability
‚úÖ Explain prices and discounts
‚úÖ Track orders by Order ID
‚úÖ Guide customers through checkout
‚úÖ Answer delivery questions (Inside Dhaka: ‡ß≥60, Outside: ‡ß≥120)

IMPORTANT RULES:
1. Be friendly, concise, and use emojis occasionally üòä
2. When mentioning products, always include price in BDT (‡ß≥)
3. If stock is 0, say 'Currently out of stock'
4. If you need human help, say: 'Let me connect you with our support team for personalized assistance.'
5. For order tracking, ask for the Order ID (format: ONXXXXXXXX or DOXXXXXXXX)
6. Always format prices as: ‡ß≥1,500 (with commas)

RESPONSE STYLE:
- Keep answers under 3 sentences when possible
- Use bullet points for product lists
- Be conversational, not robotic
");

            // üÜï DYNAMIC CONTEXT INJECTION
            string contextData = await GetRelevantContext(userMessage);
            if (!string.IsNullOrEmpty(contextData))
            {
                sb.AppendLine("\n--- REAL-TIME DATA FROM DATABASE ---");
                sb.AppendLine(contextData);
                sb.AppendLine("--- END DATA ---\n");
            }

            // Add conversation history
            if (history != null && history.Count > 0)
            {
                sb.AppendLine("Conversation history:");
                foreach (var line in history.Take(5)) // Last 5 messages only
                {
                    sb.AppendLine(line);
                }
            }

            sb.AppendLine($"\nCustomer: {userMessage}");
            sb.AppendLine("AI:");

            var requestBody = new
            {
                contents = new[] { new { parts = new[] { new { text = sb.ToString() } } } }
            };

            var jsonContent = new StringContent(
                JsonConvert.SerializeObject(requestBody),
                Encoding.UTF8,
                "application/json");

            var response = await _httpClient.PostAsync($"{ModelUrl}?key={_apiKey}", jsonContent);

            if (response.IsSuccessStatusCode)
            {
                var responseString = await response.Content.ReadAsStringAsync();
                dynamic jsonResponse = JsonConvert.DeserializeObject(responseString);
                string aiText = jsonResponse?.candidates?[0]?.content?.parts?[0]?.text;

                // üîç Check if AI is requesting human help
                if (ContainsHandoffTrigger(aiText))
                {
                    return aiText + "\n\nüîî *I've notified our team. A support agent will join shortly.*";
                }

                return aiText ?? "I'm sorry, I couldn't generate a response.";
            }

            if (!response.IsSuccessStatusCode)
            {
                var err = await response.Content.ReadAsStringAsync();
                return $"Gemini error {(int)response.StatusCode}: {err}";
            }

            return $"AI is currently unavailable. Please try again or contact support.";
        }

        // üß† INTELLIGENCE ENGINE: Detects intent and fetches relevant data
        private async Task<string> GetRelevantContext(string message)
        {
            var lowerMsg = message.ToLower();
            var context = new StringBuilder();

            try
            {
                // 1Ô∏è‚É£ PRODUCT SEARCH
                if (ContainsAny(lowerMsg, "product", "item", "buy", "purchase", "show", "find", "available", "stock", "price"))
                {
                    var productInfo = await GetProductContext(message);
                    if (!string.IsNullOrEmpty(productInfo))
                        context.AppendLine(productInfo);
                }

                // 2Ô∏è‚É£ ORDER TRACKING
                if (ContainsAny(lowerMsg, "order", "track", "delivery", "shipped", "on", "do") &&
                    (lowerMsg.Contains("on") || lowerMsg.Contains("do")))
                {
                    var orderInfo = await GetOrderContext(message);
                    if (!string.IsNullOrEmpty(orderInfo))
                        context.AppendLine(orderInfo);
                }

                // 3Ô∏è‚É£ LOW STOCK ALERTS (for recommendations)
                if (ContainsAny(lowerMsg, "recommend", "suggest", "popular", "trending", "best"))
                {
                    var trending = GetTrendingProducts();
                    if (!string.IsNullOrEmpty(trending))
                        context.AppendLine(trending);
                }
            }
            catch (Exception ex)
            {
                context.AppendLine($"Note: Some data couldn't be retrieved ({ex.Message})");
            }

            return context.ToString();
        }

        // üì¶ PRODUCT CONTEXT BUILDER
        private async Task<string> GetProductContext(string query)
        {
            try
            {
                // Extract search keywords
                var searchTerm = ExtractSearchTerm(query);
                var products = _productFacade.SearchProducts(searchTerm);

                if (products == null || products.Count == 0)
                    return $"‚ùå No products found matching '{searchTerm}'";

                var sb = new StringBuilder();
                sb.AppendLine($"üì¶ **Products matching '{searchTerm}':**\n");

                int count = 0;
                foreach (var p in products.Take(5)) // Limit to 5 results
                {
                    count++;

                    // Get variant stock info
                    var variants = _productFacade.GetVariantsByProductId(p.Id);
                    int totalStock = variants?.Sum(v => v.StockQty) ?? 0;

                    string stockStatus = totalStock > 0 ? $"‚úÖ In Stock ({totalStock} available)" : "‚ùå Out of Stock";

                    // Get best discount
                    var discount = _productFacade.GetBestDiscount(p.Id, p.BasePrice ?? 0);
                    string priceDisplay = discount != null
                        ? $"‡ß≥{p.SellingPrice:N0} (was ‡ß≥{p.BasePrice:N0})"
                        : $"‡ß≥{p.BasePrice:N0}";

                    sb.AppendLine($"{count}. **{p.ProductName}**");
                    sb.AppendLine($"   Price: {priceDisplay}");
                    sb.AppendLine($"   Stock: {stockStatus}");

                    if (!string.IsNullOrEmpty(p.Description))
                    {
                        var desc = p.Description.Length > 100
                            ? p.Description.Substring(0, 100) + "..."
                            : p.Description;

                        sb.AppendLine($"   Description: {desc}");
                    }

                    sb.AppendLine();
                }

                return sb.ToString();
            }
            catch (Exception ex)
            {
                return $"Error fetching products: {ex.Message}";
            }
        }

        // üìã ORDER TRACKING CONTEXT
        private async Task<string> GetOrderContext(string message)
        {
            try
            {
                // Extract Order ID (format: ON12345678 or DO12345678)
                var orderIdMatch = System.Text.RegularExpressions.Regex.Match(
                    message,
                    @"(ON|DO)\d{8}",
                    System.Text.RegularExpressions.RegexOptions.IgnoreCase);

                if (!orderIdMatch.Success)
                    return "üí° To track your order, please provide your Order ID (e.g., ON12345678 or DO12345678)";

                string orderId = orderIdMatch.Value.ToUpper();

                // Fetch order details
                var orderDetails = _orderFacade.GetOrderReceiptByOnlineId(orderId);

                if (orderDetails == null || orderDetails.Count == 0)
                    return $"‚ùå Order {orderId} not found. Please verify the Order ID.";

                var order = orderDetails[0] as dynamic;

                var sb = new StringBuilder();
                sb.AppendLine($"üì¶ **Order {orderId} Status:**\n");
                sb.AppendLine($"Status: {order.Status}");
                sb.AppendLine($"Order Date: {Convert.ToDateTime(order.OrderDate):dd MMM yyyy}");
                sb.AppendLine($"Total Amount: ‡ß≥{order.TotalAmount:N0}");

                if (order.Status == "Shipped" || order.Status == "Delivered")
                    sb.AppendLine($"Delivery: Expected in 2-5 business days");

                return sb.ToString();
            }
            catch (Exception ex)
            {
                return $"Error tracking order: {ex.Message}";
            }
        }

        // üî• TRENDING PRODUCTS
        private string GetTrendingProducts()
        {
            try
            {
                var lowStock = _productFacade.GetLowStockVariants(5);

                if (lowStock == null || lowStock.Count == 0)
                    return "";

                var sb = new StringBuilder();
                sb.AppendLine("üî• **Trending/Low Stock Items (Grab them fast!):**\n");

                foreach (var item in lowStock)
                {
                    sb.AppendLine($"‚Ä¢ {item.ProductName} - ‡ß≥{item.Price:N0} (Only {item.StockQty} left!)");
                }

                return sb.ToString();
            }
            catch
            {
                return "";
            }
        }

        // üîç HELPER: Extract search keywords
        private string ExtractSearchTerm(string message)
        {
            var stopWords = new[] { "show", "me", "find", "search", "for", "the", "a", "an", "want", "need", "looking", "any" };
            var words = message.ToLower()
                              .Split(new[] { ' ', ',', '?', '!' }, StringSplitOptions.RemoveEmptyEntries)
                              .Where(w => !stopWords.Contains(w) && w.Length > 2);

            return string.Join(" ", words);
        }

        // üîç HELPER: Check if message contains any keyword
        private bool ContainsAny(string text, params string[] keywords)
        {
            return keywords.Any(k => text.Contains(k));
        }

        // üö® HELPER: Detect if AI wants human takeover
        private bool ContainsHandoffTrigger(string aiResponse)
        {
            if (string.IsNullOrEmpty(aiResponse)) return false;

            var triggers = new[] {
                "support team",
                "human agent",
                "connect you",
                "speak with someone",
                "can't help with that",
                "beyond my capability"
            };

            return triggers.Any(t => aiResponse.ToLower().Contains(t));
        }
    }
}
_______________________________________________________________________
using DotNetEnv;
using MDUA.Facade;
using MDUA.Facade.Interface;

using MDUA.Web.UI.Hubs;
using MDUA.Web.UI.Services;

using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using System.Security.Claims;
var builder = WebApplication.CreateBuilder(args);
Env.Load();

// 2. Load nvironment Variables into Configuration
builder.Configuration.AddEnvironmentVariables();
System.Transactions.TransactionManager.ImplicitDistributedTransactions = true;
// 1. Register Services and Facades
builder.Services.AddService();
builder.Services.AddControllersWithViews();
builder.Services.AddHttpClient<IAiChatService, SmartGeminiChatService>();

// ‚úÖ NEW: Add SignalR Service
builder.Services.AddSignalR();

// 2. Configure Authentication with "Real World" Validation
builder.Services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
    .AddCookie(options =>
    {
        options.LoginPath = "/Account/LogIn";
        options.LogoutPath = "/Account/Logout";
        options.AccessDeniedPath = "/Account/AccessDenied";
        options.ExpireTimeSpan = TimeSpan.FromMinutes(60);
        options.SlidingExpiration = true;
        options.Cookie.HttpOnly = true;
        options.Cookie.IsEssential = true;

        // ‚úÖ THE MAGIC EVENT: Runs on every single request
        options.Events = new CookieAuthenticationEvents
        {
            OnValidatePrincipal = async context =>
            {
                // A. Check for SessionKey
                var sessionClaim = context.Principal.FindFirst("SessionKey");
                if (sessionClaim == null)
                {
                    context.RejectPrincipal();
                    await context.HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
                    return;
                }

                // B. Resolve Services (Cannot use Constructor Injection here)
                var userFacade = context.HttpContext.RequestServices.GetRequiredService<IUserLoginFacade>();

                // C. Parse Session Key
                if (Guid.TryParse(sessionClaim.Value, out Guid sessionKey))
                {
                    // D. Check if Session is still Active in DB
                    bool isValid = userFacade.IsSessionValid(sessionKey);

                    if (!isValid)
                    {
                        // ‚ùå BANNED: Kill the request immediately
                        context.RejectPrincipal();
                        await context.HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
                    }
                    else
                    {
                        // ‚úÖ VALID: Now force-refresh Permissions (Real-Time Authorization)
                        var userIdClaim = context.Principal.FindFirst(ClaimTypes.NameIdentifier);
                        if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
                        {
                            var identity = (ClaimsIdentity)context.Principal.Identity;

                            // 1. Remove OLD permissions (stale data from cookie)
                            var oldPermissionClaims = identity.FindAll("Permission").ToList();
                            foreach (var oldClaim in oldPermissionClaims)
                            {
                                identity.RemoveClaim(oldClaim);
                            }

                            // 2. Fetch NEW permissions from DB
                            var freshPermissions = userFacade.GetAllUserPermissionNames(userId);

                            // 3. Add NEW permissions to the current request
                            foreach (var permissionName in freshPermissions)
                            {
                                identity.AddClaim(new Claim("Permission", permissionName));
                            }
                        }
                    }
                }
                else
                {
                    // Invalid Guid format
                    context.RejectPrincipal();
                    await context.HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
                }
            }
        };
    });

builder.Services.AddHttpContextAccessor();
builder.Services.AddDistributedMemoryCache(); // Stores session in memory
builder.Services.AddSession(options =>
{
    options.IdleTimeout = TimeSpan.FromMinutes(30); // Set timeout
    options.Cookie.HttpOnly = true;
    options.Cookie.IsEssential = true;
});
var app = builder.Build();

// 3. Middlewares
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Home/Error");
}

app.UseStaticFiles();
app.UseRouting();
app.UseSession(); // üëà THIS MUST BE HERE
app.UseAuthentication();
app.UseAuthorization();

// ‚úÖ NEW: Map the SignalR Hub
// This creates the endpoint "/supportHub" that combo.js connects to
app.MapHub<SupportHub>("/supportHub");

app.MapControllerRoute(
    name: "default",
    pattern: "{controller=Home}/{action=Index}/{id?}");

app.Run();