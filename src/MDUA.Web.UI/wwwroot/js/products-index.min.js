$(document).ready(function(){let l=$('input[name="__RequestVerificationToken"]').val(),p=$("#modal-variants-content");const o=window.productConfig?window.productConfig.urls:{};(function(t){var e=t.ajax;t.ajax=function(a){var i=a.success;return a.success=function(n,d,r){if(n&&n.success===!1&&n.redirectUrl){window.location.href=n.redirectUrl;return}i&&i(n,d,r)},e(a)}})(jQuery);function v(t){let e=$(`tr[data-product-row-id="${t}"]`),a=e.find(".price-cell");e.length!==0&&$.get(o.getUpdatedPrice,{productId:t},function(i){if(i.success){let n="";i.hasDiscount?n=`<span class="original-price">${i.originalPrice}</span><br/>
                            <span class="discounted-price">${i.sellingPrice}</span>`:n=`<span>${i.originalPrice}</span>`,a.html(n)}})}function g(){let t=[];$(".attr-name-select").each(function(){let e=$(this).val();e&&t.push(e)}),$(".attr-name-select").each(function(){let e=$(this).val();$(this).find("option").each(function(){let a=$(this).val();a&&t.includes(a)&&a!==e?$(this).prop("disabled",!0):$(this).prop("disabled",!1)})})}function m(){let t=$("#dynamic-attributes-container .dynamic-attr-row").length,e=$("#attribute-template").html();(!e||e.trim()==="")&&(console.error("Attribute Template is empty. Ensure Facade loads Attributes."),e='<option value="">Error: No Attributes Found</option>');let a=`
            <div class="dynamic-attr-row mb-2 d-flex gap-2 align-items-center">
                <select class="form-control form-control-sm attr-name-select" style="width: 45%;">
                    ${e}
                </select>
                
                <select class="form-control form-control-sm attr-value-select" style="width: 45%;" disabled>
                    <option value="">Select Value</option>
                </select>
                
                <input type="hidden" name="AttributeValueIds[${t}]" class="final-value-id" />

                <button type="button" class="btn btn-sm btn-outline-danger remove-attr-row" style="width: 10%;">&times;</button>
            </div>
        `;$("#dynamic-attributes-container").append(a),g()}$(document).on("click","#btn-add-dynamic-attr",function(){m()}),$(document).on("click",".remove-attr-row",function(){$(this).closest(".dynamic-attr-row").remove(),$("#dynamic-attributes-container .dynamic-attr-row").each(function(t){$(this).find(".final-value-id").attr("name",`AttributeValueIds[${t}]`)}),g()}),$(document).on("change",".attr-name-select",function(){let t=$(this),a=t.closest(".dynamic-attr-row").find(".attr-value-select"),i=t.val();g(),i?(a.html("<option>Loading...</option>").prop("disabled",!0),$.get(o.getAttributeValues,{attributeId:i},function(n){let d='<option value="">Select Value</option>';n&&n.length>0?n.forEach(r=>{d+=`<option value="${r.id}">${r.value}</option>`}):d='<option value="">No values found</option>',a.html(d).prop("disabled",!1)})):a.html('<option value="">Select Value</option>').prop("disabled",!0)}),$(document).on("change",".attr-value-select",function(){let t=$(this).val();$(this).siblings(".final-value-id").val(t)}),p.on("click","#btn-save-new-variant",function(){let t=$("#form-add-single-variant"),a=[$("#modal-product-name").text().trim()],i=!0;if($(".dynamic-attr-row").length===0){alert("Please add at least one attribute.");return}if($(".attr-value-select").each(function(){$(this).val()?($(this).removeClass("is-invalid"),a.push($(this).find("option:selected").text())):(i=!1,$(this).addClass("is-invalid"))}),!i){alert("Please select values for all attributes.");return}let n=a.join(" - "),d=!1;if($(".variants-table-modal tbody tr").each(function(){if($(this).find("td:first").text().trim()===n)return d=!0,!1}),d){$("#duplicate-variant-name").text(n),$("#duplicateVariantModal").modal("show");return}$("#new-variant-name").val(n);let r=$(this);r.prop("disabled",!0).text("Saving..."),$.ajax({url:o.addSingleVariant,type:"POST",headers:{RequestVerificationToken:l},data:t.serialize(),success:function(u){if(u.success){let h=t.find('input[name="ProductId"]').val();$.get(o.getVariantsPartial,{productId:h},function(b){$("#modal-variants-content").html(b),m()})}else alert("Error: "+u.message),r.prop("disabled",!1).text("Save New Variant")},error:function(){r.prop("disabled",!1).text("Save New Variant")}})}),$(".btn-view-variants").on("click",function(){var t=$(this).data("product-id"),e=$(this).closest("tr").find("td[data-product-name]").data("product-name");$("#modal-product-name").text(e),$("#modal-variants-content").html('<div class="loading-spinner"></div>'),$.get(o.getVariantsPartial,{productId:t},function(a){$("#modal-variants-content").html(a),m()}).fail(function(){$("#modal-variants-content").html('<div class="error-message">Failed to load variants.</div>')})}),$(".js-toggle-status").on("click",function(){let t=$(this),e=t.data("product-id");t.prop("disabled",!0),$.ajax({url:o.toggleStatus,type:"POST",headers:{RequestVerificationToken:l},data:{productId:e},success:function(a){a.success?(t.text(a.newIsActive?"Active":"Inactive"),t.removeClass("bg-success-subtle text-success bg-danger-subtle text-danger"),t.addClass(a.newIsActive?"bg-success-subtle text-success":"bg-danger-subtle text-danger")):alert(a.message)},complete:function(){t.prop("disabled",!1)}})}),$(".js-view-details").on("click",function(){let t=$(this),e=t.data("product-id"),a=t.closest("tr").find("td[data-product-name]").data("product-name");$("#productDetailsModalLabel").text("Details for "+a),$("#modal-details-content").html('<div class="loading-spinner"></div>'),$.get(o.getProductDetailsPartial,{productId:e},function(i){$("#modal-details-content").html(i)}).fail(function(){$("#modal-details-content").html('<div class="error-message">Failed to load details.</div>')})}),$(".js-edit-product").on("click",function(){let t=$(this),e=t.data("product-id"),a=t.data("product-name");$("#editProductModalLabel").text("Edit: "+a),$("#modal-edit-content").html('<div class="loading-spinner"></div>'),$.get(o.getEditPartial,{productId:e},function(i){$("#modal-edit-content").html(i)}).fail(function(){$("#modal-edit-content").html('<div class="error-message">Failed to load form.</div>')})}),$(".js-delete-product").on("click",function(){let t=$(this).data("product-id"),e=$(this).data("product-name");$("#modal-delete-product-name").text(e),$("#confirm-delete-button").data("product-id",t)});let f=document.getElementById("confirm-delete-checkbox");f&&f.addEventListener("change",function(){document.getElementById("confirm-delete-button").disabled=!this.checked}),$("#deleteProductModal").on("hidden.bs.modal",function(){f&&(f.checked=!1),document.getElementById("confirm-delete-button").disabled=!0}),$("#confirm-delete-button").on("click",function(){let t=$(this),e=t.data("product-id");t.prop("disabled",!0).text("Deleting..."),$.ajax({url:o.deleteConfirmed,type:"POST",headers:{RequestVerificationToken:l},data:{productId:e},success:function(a){a.success?($("#deleteProductModal").modal("hide"),$('tr[data-product-row-id="'+e+'"]').fadeOut(500,function(){$(this).remove()})):alert("Error: "+a.message)},complete:function(){t.prop("disabled",!1).text("Delete Product")}})}),p.on("click",".js-delete-variant",function(){let e=$(this).closest("tr"),a=e.data("variant-id"),i=e.find("td:first").text().trim();$("#modal-delete-variant-name").text(i),$("#confirm-delete-variant-button").data("variant-id",a),$("#deleteVariantModal").modal("show")}),$("#confirm-delete-variant-button").on("click",function(){let t=$(this),e=t.data("variant-id");t.prop("disabled",!0).text("Deleting..."),$.ajax({url:o.deleteVariant,type:"POST",headers:{RequestVerificationToken:l},data:{variantId:e},success:function(a){a.success?($("#deleteVariantModal").modal("hide"),$('tr[data-variant-id="'+e+'"]').fadeOut(300,function(){$(this).remove(),$("#modal-variants-content tbody tr").length===0&&$("#modal-variants-content").html('<div class="empty-state"><p>No variants found.</p></div>')})):alert("Error: "+a.message)},complete:function(){t.prop("disabled",!1).text("Delete Variant")}})}),p.on("click",".js-edit-variant",function(){let t=$(this),e=t.closest("tr"),a=e.data("variant-id");if(t.hasClass("text-warning")){e.find('td[data-col="price"] .display-value').hide(),e.find('td[data-col="price"] .edit-input').show(),e.find('td[data-col="sku"] .display-value').hide(),e.find('td[data-col="sku"] .edit-input').show();let n=e.find("td:first");n.find(".btn-add-attr-inline").length===0&&n.append(`
                    <button type="button" class="btn btn-xs btn-outline-primary ms-2 btn-add-attr-inline" 
                        title="Add missing attribute" style="padding: 0px 4px; font-size: 10px;">
                        + Add Attr
                    </button>
                `),n.find(".btn-add-attr-inline").show(),t.removeClass("text-warning").addClass("text-success").html('<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>')}else{let n=e.find('td[data-col="price"] .edit-input').val(),d=e.find('td[data-col="sku"] .edit-input').val();t.prop("disabled",!0).text("Saving..."),$.ajax({url:o.updateVariantPrice,type:"POST",headers:{RequestVerificationToken:l},data:{variantId:a,newPrice:n,newSku:d},success:function(r){r.success?(e.find('td[data-col="price"] .display-value').text("Tk. "+parseFloat(n).toFixed(2)),e.find('td[data-col="sku"] .display-value').text(d||"N/A"),e.find(".display-value").show(),e.find(".edit-input").hide(),e.find(".btn-add-attr-inline").hide(),t.removeClass("text-success").addClass("text-warning").html('<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>')):alert("Error: "+r.message)},complete:function(){t.prop("disabled",!1)}})}}),p.on("click",".btn-add-attr-inline",function(t){t.stopPropagation();let a=$(this).closest("tr").data("variant-id"),i=$('input[name="ProductId"]').val();$("#target-variant-id").val(a),$("#missing-attr-select").html("<option>Loading...</option>"),$("#missing-value-select").html("<option>Select Value</option>").prop("disabled",!0),$("#addVariantAttributeModal").modal("show"),$.get(o.getMissingAttributes,{productId:i,variantId:a},function(n){let d='<option value="">Select Attribute</option>';n&&n.length>0?n.forEach(r=>{d+=`<option value="${r.id}">${r.name}</option>`}):d='<option value="">No missing attributes!</option>',$("#missing-attr-select").html(d)})}),$("#missing-attr-select").on("change",function(){let t=$(this).val(),e=$("#missing-value-select");t&&(e.html("<option>Loading...</option>").prop("disabled",!0),$.get(o.getAttributeValues,{attributeId:t},function(a){let i='<option value="">Select Value</option>';a.forEach(n=>{i+=`<option value="${n.id}">${n.value}</option>`}),e.html(i).prop("disabled",!1)}))}),$("#btn-confirm-add-attr").on("click",function(){let t=$("#target-variant-id").val(),e=$("#missing-value-select").val(),a=$('input[name="ProductId"]').val();if(!e){alert("Select a value");return}$(this).prop("disabled",!0).text("Adding..."),$.ajax({url:o.addAttributeToVariant,type:"POST",headers:{RequestVerificationToken:l},data:{variantId:t,attributeValueId:e},success:function(i){i.success?($("#addVariantAttributeModal").modal("hide"),$.get(o.getVariantsPartial,{productId:a},function(n){$("#modal-variants-content").html(n),m()})):alert("Failed")},complete:function(){$("#btn-confirm-add-attr").prop("disabled",!1).text("Add & Update")}})}),$(".js-manage-discounts").on("click",function(){let t=$(this).data("product-id"),e=$(this).data("product-name");$("#modal-discount-product-name").text(e),$("#modal-discounts-content").html('<div class="loading-spinner"></div>'),$.get(o.getDiscounts,{productId:t},function(a){$("#modal-discounts-content").html(a)})}),$(document).on("click","#btn-save-discount",function(){let t=$("#form-add-discount"),e=t.find('input[name="ProductId"]').val(),a=$(this);a.prop("disabled",!0).text("Adding..."),$.ajax({url:o.addDiscount,type:"POST",headers:{RequestVerificationToken:l},data:t.serialize(),success:function(i){i.success?($.get(o.getDiscounts,{productId:e},function(n){$("#modal-discounts-content").html(n)}),v(e)):(alert("Error: "+i.message),a.prop("disabled",!1).text("Add Discount"))},error:function(){a.prop("disabled",!1).text("Add Discount")}})}),$(document).on("click",".js-delete-discount",function(){let t=$(this).closest("tr"),e=t.data("id"),a=t.find('td[data-col="type"] .display-value').text(),i=t.find('td[data-col="value"] .display-value').text(),n=`${a} : ${i}`;$("#modal-delete-discount-info").text(n),$("#confirm-delete-discount-button").data("discount-id",e),$("#deleteDiscountModal").modal("show")}),$(document).on("click","#confirm-delete-discount-button",function(){let t=$(this),e=t.data("discount-id");t.prop("disabled",!0).text("Deleting..."),$.ajax({url:o.deleteDiscount,type:"POST",headers:{RequestVerificationToken:l},data:{id:e},success:function(a){if(a.success){$("#deleteDiscountModal").modal("hide"),$(`.discounts-table tr[data-id="${e}"]`).fadeOut(300,function(){$(this).remove(),$(".discounts-table tbody tr").length===0&&$(".discounts-table tbody").html('<tr><td colspan="7" class="text-center text-muted">No discounts found.</td></tr>')});let n=$('#form-add-discount input[name="ProductId"]').val();v(n)}else alert("Error: "+a.message)},complete:function(){t.prop("disabled",!1).text("Delete Discount")}})}),$(document).on("click",".js-edit-discount",function(){let t=$(this),e=t.closest("tr");if(t.text().trim()==="Edit")e.find(".display-value").hide(),e.find(".edit-input").show(),t.text("Save").removeClass("btn-warning").addClass("btn-success");else{let i=e.data("id"),n=$('#form-add-discount input[name="ProductId"]').val(),d={Id:i,ProductId:n,DiscountType:e.find('td[data-col="type"] select').val(),DiscountValue:e.find('td[data-col="value"] input').val(),MinQuantity:e.find('td[data-col="qty"] input').val(),EffectiveFrom:e.find('td[data-col="from"] input').val(),EffectiveTo:e.find('td[data-col="to"] input').val(),IsActive:e.find('td[data-col="active"] select').val(),CreatedBy:"",CreatedAt:new Date().toISOString()};t.prop("disabled",!0).text("Saving..."),$.ajax({url:o.updateDiscount,type:"POST",headers:{RequestVerificationToken:l},data:d,success:function(r){r.success?($.get(o.getDiscounts,{productId:n},function(u){$("#modal-discounts-content").html(u)}),v(n)):(alert("Error saving"),t.prop("disabled",!1).text("Save"))},error:function(){alert("Server Error"),t.prop("disabled",!1).text("Save")}})}});let s;$(".js-manage-images").on("click",function(){let t=$(this).data("product-id");$("#modal-images-content").data("product-id",t),$.get(o.getImages,{productId:t},function(e){$("#modal-images-content").html(e)}),$("#productImagesModal").modal("show")}),$(document).on("change","#upload-image-input",function(t){let e=t.target.files;if(e&&e.length>0){let a=e[0],i=URL.createObjectURL(a);$("#cropper-wrapper, #cropper-controls").show(),$("#upload-image-input").closest(".mb-3").hide();let n=document.getElementById("image-to-crop");n.src=i,s&&s.destroy(),n.onload=function(){s=new Cropper(n,{aspectRatio:1,viewMode:1,autoCropArea:1})}}}),$(document).on("click","#btn-close-cropper",function(){s&&(s.destroy(),s=null),$("#cropper-wrapper, #cropper-controls").hide(),$("#upload-image-input").val("").closest(".mb-3").show()}),$(document).on("click","#btn-confirm-upload",function(){if(!s)return;let t=$(this);t.prop("disabled",!0).text("Uploading..."),s.getCroppedCanvas({width:800,height:800}).toBlob(e=>{let a=new FormData,i=$("#modal-images-content").data("product-id");a.append("file",e,"image.jpg"),a.append("productId",i),$.ajax({url:o.uploadImage,method:"POST",headers:{RequestVerificationToken:l},data:a,processData:!1,contentType:!1,success:function(n){n.success?$.get(o.getImages,{productId:i},function(d){$("#modal-images-content").html(d),s&&(s.destroy(),s=null),$("#cropper-wrapper, #cropper-controls").hide(),$("#upload-image-input").val("").closest(".mb-3").show()}):alert("Upload failed: "+n.message)},complete:function(){t.prop("disabled",!1).html('<i class="fas fa-check"></i> Save Image')}})})}),$(document).on("click",".js-delete-image",function(){let t=$(this).data("id");$("#btn-confirm-del-prod-img").data("id",t),$("#deleteProductImageModal").modal("show")}),$(document).on("click","#btn-confirm-del-prod-img",function(){let t=$(this),e=t.data("id"),a=$("#modal-images-content").data("product-id");t.prop("disabled",!0).text("Deleting..."),$.ajax({url:o.deleteImage,type:"POST",headers:{RequestVerificationToken:l},data:{id:e},success:function(i){i.success?($("#deleteProductImageModal").modal("hide"),$.get(o.getImages,{productId:a},function(n){$("#modal-images-content").html(n)})):alert("Error deleting")},complete:function(){t.prop("disabled",!1).text("Delete")}})}),$(document).on("click",".js-prod-zoom-in",function(){s&&s.zoom(.1)}),$(document).on("click",".js-prod-zoom-out",function(){s&&s.zoom(-.1)});let c;$(document).on("click",".js-manage-var-images",function(){let e=$(this).closest("tr").data("variant-id");$("#modal-var-images-content").data("variant-id",e),$("#modal-var-images-content").html('<div class="loading-spinner"></div>'),$.get(o.getVariantImages,{variantId:e},function(a){$("#modal-var-images-content").html(a)}),$("#variantImagesModal").modal("show")}),$(document).on("change","#upload-variant-image-input",function(t){let e=t.target.files[0];if(e){let a=URL.createObjectURL(e);$("#var-cropper-wrapper, #var-cropper-controls").show();let i=document.getElementById("var-image-to-crop");i.src=a,c&&c.destroy(),c=new Cropper(i,{aspectRatio:1,viewMode:1,autoCropArea:1}),$(this).val("")}}),$(document).on("click","#btn-confirm-var-upload",function(){if(!c)return;let t=$(this);t.prop("disabled",!0).text("Uploading...");let e=$("#modal-var-images-content").data("variant-id");c.getCroppedCanvas({width:600,height:600}).toBlob(a=>{let i=new FormData;i.append("file",a,"var-img.jpg"),i.append("variantId",e),$.ajax({url:o.uploadVariantImage,type:"POST",headers:{RequestVerificationToken:l},data:i,processData:!1,contentType:!1,success:function(n){n.success?$.get(o.getVariantImages,{variantId:e},function(d){$("#modal-var-images-content").html(d),c&&(c.destroy(),c=null),$("#var-cropper-wrapper").hide()}):alert("Upload failed")},complete:function(){t.prop("disabled",!1).text("Save")}})})}),$(document).on("click",".js-del-var-img",function(){let t=$(this).data("id");$("#btn-confirm-del-var-img").data("id",t),$("#deleteVariantImageModal").modal("show")}),$(document).on("click","#btn-confirm-del-var-img",function(){let t=$(this),e=t.data("id"),a=$("#modal-var-images-content").data("variant-id");t.prop("disabled",!0).text("Deleting..."),$.ajax({url:o.deleteVariantImage,type:"POST",headers:{RequestVerificationToken:l},data:{id:e},success:function(){$("#deleteVariantImageModal").modal("hide"),$.get(o.getVariantImages,{variantId:a},function(i){$("#modal-var-images-content").html(i)})},complete:function(){t.prop("disabled",!1).text("Delete")}})}),$(document).on("click",".js-var-zoom-in",function(){c&&c.zoom(.1)}),$(document).on("click",".js-var-zoom-out",function(){c&&c.zoom(-.1)}),$(document).on("click","#btn-close-var-cropper",function(){c&&(c.destroy(),c=null),$("#var-cropper-wrapper").hide(),$("#var-cropper-controls").hide(),$("#upload-variant-image-input").val("")}),$(document).on("change",".js-set-primary",function(){let t=$(this).data("id"),e=$(this).data("product-id");$.ajax({url:"/product/set-primary-image",type:"POST",headers:{RequestVerificationToken:l},data:{imageId:t,productId:e},success:function(a){a.success&&$.get(o.getImages,{productId:e},function(i){$("#modal-images-content").html(i)})}})}),$(document).on("change",".js-update-order",function(){let t=$(this).data("id"),e=$(this).val(),a=$("#modal-images-content").data("product-id");$.ajax({url:"/product/update-image-order",type:"POST",headers:{RequestVerificationToken:l},data:{imageId:t,sortOrder:e},success:function(i){i.success&&$.get(o.getImages,{productId:a},function(n){$("#modal-images-content").html(n)})}})}),$(document).on("change",".js-update-var-order",function(){let t=$(this).data("id"),e=$(this).val(),a=$(this).data("variant-id");$.ajax({url:"/product/update-variant-image-order",type:"POST",headers:{RequestVerificationToken:l},data:{imageId:t,displayOrder:e},success:function(i){i.success&&$.get(o.getVariantImages,{variantId:a},function(n){$("#modal-var-images-content").html(n)})}})})});
