document.addEventListener("DOMContentLoaded",function(){const u=document.getElementById("requestModal"),m=document.getElementById("infoModal"),p=document.getElementById("receiveModal");[u,m,p].forEach(e=>{e&&e.parentNode!==document.body&&document.body.appendChild(e)});const y=new bootstrap.Modal(u),E=new bootstrap.Modal(m),f=new bootstrap.Modal(p);document.addEventListener("click",function(e){const a=e.target.closest(".btn-request");if(a){document.getElementById("reqVariantId").value=a.dataset.variantId,document.getElementById("reqProductName").value=a.dataset.name,document.getElementById("reqQty").value=a.dataset.suggested,y.show();return}const n=e.target.closest(".btn-receive");if(n){const s=n.dataset.variantId,c=n.dataset.name;document.getElementById("recVariantId").value=s,document.getElementById("recProductName").textContent=c,document.getElementById("recQty").value="",document.getElementById("recPrice").value="",document.getElementById("recInvoice").value="",document.getElementById("recRemarks").value="",document.getElementById("recReqQty").value="Loading...",f.show(),fetch(`/purchase/get-pending-info?variantId=${s}`).then(r=>r.json()).then(r=>{if(r.success&&r.data){const t=r.data.quantity;document.getElementById("recReqQty").value=t,document.getElementById("recQty").value=t}else document.getElementById("recReqQty").value="N/A"});return}const o=e.target.closest(".btn-req-info");if(o){const s=o.dataset.variantId,c=document.getElementById("infoModalBody");c.innerHTML='<div class="text-center text-muted py-5"><div class="spinner-border text-info"></div><div class="mt-2">Loading details...</div></div>',E.show(),fetch(`/purchase/get-pending-info?variantId=${s}`).then(r=>r.json()).then(r=>{if(r.success&&r.data){const t=r.data;c.innerHTML=`
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                    <span class="text-muted">Request ID</span>
                                    <span class="fw-bold">PO #${t.id}</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                    <span class="text-muted">Vendor</span>
                                    <span class="fw-bold text-dark">${t.vendorName}</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                    <span class="text-muted">Requested Quantity</span>
                                    <span class="badge bg-warning text-dark fs-6">${t.quantity}</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                    <span class="text-muted">Request Date</span>
                                    <span>${t.requestDate}</span>
                                </div>
                                <div class="list-group-item p-3">
                                    <span class="text-muted d-block mb-2">Remarks</span>
                                    <div class="bg-light p-2 rounded border text-break text-secondary small">
                                        ${t.remarks||"No remarks provided."}
                                    </div>
                                </div>
                            </div>`}else c.innerHTML=`<div class="text-center text-danger py-4 p-3">${r.message||"Data not found"}</div>`}).catch(()=>{c.innerHTML='<div class="text-center text-danger py-4">Failed to load data.</div>'});return}});const g=document.getElementById("btnConfirmRequest");g&&g.addEventListener("click",function(){I("/purchase/create-request",{VendorId:parseInt(document.getElementById("reqVendor").value),ProductVariantId:parseInt(document.getElementById("reqVariantId").value),Quantity:parseInt(document.getElementById("reqQty").value)},this,y)});const v=document.getElementById("btnConfirmReceive");v&&v.addEventListener("click",function(){const e={ProductVariantId:parseInt(document.getElementById("recVariantId").value),Quantity:parseInt(document.getElementById("recQty").value),BuyingPrice:parseFloat(document.getElementById("recPrice").value),InvoiceNo:document.getElementById("recInvoice").value,Remarks:document.getElementById("recRemarks").value};if(!e.ProductVariantId||isNaN(e.ProductVariantId)){alert("System Error: Variant ID missing");return}if(!e.Quantity||e.Quantity<1){alert("Please enter a valid quantity.");return}if(isNaN(e.BuyingPrice)||e.BuyingPrice<0){alert("Please enter a valid total cost.");return}I("/purchase/receive-stock",e,this,f)});function I(e,a,n,o){const s=n.textContent;n.disabled=!0,n.textContent="Processing...";const c=document.querySelector('input[name="__RequestVerificationToken"]')?.value,r={"Content-Type":"application/json"};c&&(r.RequestVerificationToken=c),fetch(e,{method:"POST",headers:r,body:JSON.stringify(a)}).then(async t=>{const d=t.headers.get("content-type");if(d&&d.includes("application/json"))return await t.json();throw new Error("Invalid Server Response")}).then(t=>{if(t.success)o.hide(),a.ProductVariantId&&b(a.ProductVariantId),typeof Swal<"u"?Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:l=>{l.addEventListener("mouseenter",Swal.stopTimer),l.addEventListener("mouseleave",Swal.resumeTimer)}}).fire({icon:"success",title:t.message||"Success"}):alert(t.message||"Success!");else throw new Error(t.message||"Unknown Error")}).catch(t=>{typeof Swal<"u"?Swal.fire("Error",t.message,"error"):alert("Error: "+t.message)}).finally(()=>{n.disabled=!1,n.textContent=s})}function b(e){const a=document.getElementById(`row-${e}`);a&&(a.style.transition="opacity 0.3s",a.style.opacity="0.4",fetch(`/purchase/get-variant-row?variantId=${e}`).then(n=>n.text()).then(n=>{a.outerHTML=n;const o=document.getElementById(`row-${e}`);o&&(o.style.backgroundColor="#e8f5e9",setTimeout(()=>{o.style.backgroundColor=""},1e3)),w(e)}).catch(n=>console.error("Auto-refresh failed:",n)))}function w(e){const a=document.getElementById(`row-${e}`);if(!a)return;const n=a.closest(".collapse");if(!n)return;let o=0;n.querySelectorAll('[id^="stock-"]').forEach(r=>{const t=parseInt(r.textContent.trim())||0;o+=t});const c=document.querySelector(`button[data-bs-target="#${n.id}"]`);if(c){const t=c.closest("tr").querySelector(".group-total-stock");t&&(t.style.transition="color 0.3s",t.style.color="#198754",t.textContent=o,setTimeout(()=>{t.style.color=""},1e3))}}const h=document.getElementById("productSearch");h&&h.addEventListener("keyup",function(e){const a=e.target.value.toLowerCase();document.querySelectorAll(".product-card").forEach(o=>{(o.dataset.searchTerm||"").includes(a)?o.classList.remove("d-none"):o.classList.add("d-none")})}),document.body.addEventListener("change",function(e){if(e.target.classList.contains("variant-checkbox")){const a=e.target,n=a.closest("tr"),o=n.querySelectorAll(".input-vendor, .input-qty, .input-remarks");a.checked?(n.classList.add("table-primary"),o.forEach(s=>s.disabled=!1)):(n.classList.remove("table-primary"),o.forEach(s=>s.disabled=!0))}});const i=document.getElementById("btnSubmitBulk");i&&i.addEventListener("click",function(){const e=document.querySelectorAll(".variant-checkbox:checked");if(e.length===0){alert("Please select at least one item to order.");return}const a=[];let n=!1;if(e.forEach(s=>{const c=s.closest("tr"),r=s.dataset.variantId,t=c.querySelector(".input-vendor").value,d=c.querySelector(".input-qty").value,l=c.querySelector(".input-remarks").value;!t||!d||d<=0?(n=!0,c.classList.add("table-danger"),setTimeout(()=>c.classList.remove("table-danger"),2e3)):a.push({ProductVariantId:parseInt(r),VendorId:parseInt(t),Quantity:parseInt(d),Remarks:l})}),n){alert("Please select a Vendor and valid Quantity for all checked items.");return}const o=i.innerHTML;i.disabled=!0,i.innerHTML='<span class="spinner-border spinner-border-sm"></span> Processing...',fetch("/purchase/bulk-create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(s=>s.json()).then(s=>{s.success?typeof Swal<"u"?Swal.fire({icon:"success",title:"Order Placed!",text:s.message,confirmButtonText:"OK"}).then(()=>{window.location.reload()}):(alert(s.message),window.location.reload()):alert("Error: "+s.message)}).catch(s=>{alert("System Error: "+s.message)}).finally(()=>{i.disabled=!1,i.innerHTML=o})})});
