$(document).ready(function(){const p=window.baseProductInfo||{price:0,image:"/images/default-product.jpg"};let o=p.price,s=0,u={},c=!1,g=!1,h=null;const k=typeof deliveryCharges<"u"?deliveryCharges:{dhaka:0,outside:0},S=p.image;$("#display-price").text("Tk. "+o.toLocaleString()),$("#summary-subtotal").text("Tk. "+o.toLocaleString());function E(e,t){let i;return function(){const r=this,l=arguments;clearTimeout(i),i=setTimeout(()=>e.apply(r,l),t)}}const b=window.productVariants||[];if(b.length===1){const e=b[0];w(e),$(".variant-chip").addClass("selected"),e.attributes&&(u={...e.attributes})}$(document).on("click",".variant-chip",function(){let e=$(this),t=e.data("attribute"),i=e.data("value");e.hasClass("selected")?(e.removeClass("selected"),delete u[t]):($(`.variant-chip[data-attribute='${t}']`).removeClass("selected"),e.addClass("selected"),u[t]=i),I()});function I(){$("#selected-variant-id").val("");const e=b.find(t=>{for(let i in u)if(!t.attributes[i]||String(t.attributes[i])!==String(u[i]))return!1;return!0});e?Object.keys(u).length>0?w(e):D():P()}function w(e){$("#selected-variant-id").val(e.id),o=e.price,$("#display-price").text("Tk. "+o.toLocaleString()),s=e.stock;let t=parseInt($("#quantity").val())||1;s>0&&t>s&&$("#quantity").val(s),T(s);let i=e.image&&e.image.length>1?e.image:S;!i.startsWith("/")&&!i.startsWith("http")&&(i="/"+i),$("#order-variant-image").attr("src",i),$(".variant-chips-container").css("border","none"),m(),!c&&!$("#email-status").is(":visible")&&$(".submit-btn").prop("disabled",!1)}function D(){o=p.price,$("#display-price").text("Tk. "+o.toLocaleString()),$("#order-variant-image").attr("src",S),$("#selected-variant-id").val(""),s=0,T(0),m()}function P(){$("#stock-message").text("This combination is currently unavailable.").addClass("text-danger show"),$("#order-variant-image").attr("src",S),$("#selected-variant-id").val(""),s=0}function T(e){const t=$("#stock-message");t.removeClass("stock-high stock-medium stock-low text-danger show"),!(Object.keys(u).length===0&&b.length>1)&&(e<=0?t.text("Out of Stock").addClass("text-danger show"):e>=10?t.text(`In stock: ${e} items`).addClass("stock-high show"):e>=3?t.text(`Hurry! Only ${e} left`).addClass("stock-medium show"):e>0&&t.text(`Last few! Just ${e} left`).addClass("stock-low show"))}function f(e){const t=$("#stock-error-message");t.text(e).addClass("show"),setTimeout(()=>{t.removeClass("show")},3e3)}function q(){$("#stock-error-message").text("").removeClass("show")}$("#customerEmail").on("input",function(){g=!1,$("#email-status").hide(),$(".submit-btn").prop("disabled",!1).text("Confirm Order")}),$("#customerEmail").on("blur",function(){const e=$(this).val().trim(),t=$("#email-status");if(t.hide().removeClass("text-danger").removeClass("text-success"),!e){$(".submit-btn").prop("disabled",!1).text("Confirm Order");return}if(g&&e===h){t.text("\u2713 Using your registered email").css("color","green").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order");return}if(!e.includes("@")){t.text("\u26A0 Please enter a valid email address").css("color","orange").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order");return}c=!0,t.text("\u23F3 Checking email...").css("color","blue").show(),$(".submit-btn").prop("disabled",!0).text("Verifying..."),$.get("/order/check-email",{email:e},function(i){c=!1,i.exists?e===h?(t.text("\u2713 Using your registered email").css("color","green").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order")):(t.text("\u2717 Email already exists! Please use another.").css("color","red").show(),$(".submit-btn").prop("disabled",!0).text("Confirm Order")):(t.text("\u2713 Email available").css("color","green").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order"))}).fail(function(){c=!1,t.text("\u26A0 Could not verify email. Please try again.").css("color","orange").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order")})}),$("#customerPhone").on("input",E(function(){let e=$(this).val();e.length>=11?($("#phone-status").text("\u23F3 Checking...").css("color","blue"),$.get("/order/check-customer",{phone:e},function(t){if(t.found){if($("#phone-status").text("\u2713 Welcome back! Info loaded.").css("color","green"),t.name&&$("#customerName").val(t.name),t.email){const i=$("#customerEmail"),r=i.val().trim();!r||r.includes("@guest.local")?(g=!0,h=t.email,i.val(t.email),$("#email-status").text("\u2713 Using your registered email").css("color","green").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order")):h=t.email}if(t.addressData){const i=t.addressData;$('textarea[name="Street"]').val(i.street),$('input[name="PostalCode"]').val(i.postalCode),$('input[name="ZipCode"]').val(i.zipCode),$("#division-select").val(i.divison).trigger("change"),setTimeout(()=>{$("#district-select").val(i.city).trigger("change")},500)}}else $("#phone-status").text("New Customer").css("color","#666"),g=!1,h=null}).fail(function(){$("#phone-status").text("\u26A0 Could not verify phone").css("color","orange")})):($("#phone-status").text(""),g=!1,h=null)},500));function n(e,t){$(e).empty().append(`<option value="">${t}</option>`).prop("disabled",!0)}function y(e,t,i){let r=$(e);if(r.empty().append(`<option value="">${i}</option>`),!t||t.length===0){r.append('<option value="" disabled>No options available</option>'),r.prop("disabled",!1);return}t.forEach(l=>{let d=l.name||l.Name||l,v=l.name||l.Name||l,a=l.code||l.Code||"";r.append(`<option value="${d}" data-code="${a}">${v}</option>`)}),r.prop("disabled",!1)}function L(){$.get("/order/get-divisions",function(e){y("#division-select",e,"Select Division")}).fail(function(){$("#division-select").append("<option>Error loading data</option>")})}L(),$("#division-select").change(function(){let e=$(this).val();n("#district-select","Loading..."),n("#thana-select","Select District first"),n("#suboffice-select","Select Thana first"),e?$.get("/order/get-districts",{division:e},function(t){y("#district-select",t,"Select District")}).fail(function(){n("#district-select","Error loading districts"),$("#district-select").prop("disabled",!1)}):n("#district-select","Select Division first")}),$("#district-select").change(function(){let e=$(this).val();n("#thana-select","Loading..."),n("#suboffice-select","Select Thana first");let t=k.outside;e&&(e.toLowerCase().includes("dhaka")||e.trim()==="Dhaka")&&(t=k.dhaka),$("#receipt-delivery").text("Tk. "+t).data("cost",t),m(),e?$.get("/order/get-thanas",{district:e},function(i){y("#thana-select",i,"Select Thana")}).fail(function(){n("#thana-select","Error loading thanas"),$("#thana-select").prop("disabled",!1)}):n("#thana-select","Select District first")}),$("#thana-select").change(function(){let e=$(this).val();n("#suboffice-select","Loading..."),e?$.get("/order/get-suboffices",{thana:e},function(t){y("#suboffice-select",t,"Select Sub-Office")}).fail(function(){n("#suboffice-select","Error loading sub-offices"),$("#suboffice-select").prop("disabled",!1)}):n("#suboffice-select","Select Thana first")}),$("#suboffice-select").change(function(){let e=$(this).find(":selected").data("code");e&&$('input[name="PostalCode"]').val()!=e&&$('input[name="PostalCode"]').val(e).css("border-color","#2ecc71")});function m(){let e=parseInt($("#quantity").val())||1,t=o*e,i=parseFloat($("#receipt-delivery").data("cost"))||0,r=t+i;$("#summary-qty").text(e),$("#summary-subtotal").text("Tk. "+t.toLocaleString()),$("#receipt-grand-total").text("Tk. "+r.toLocaleString())}$("#increase").click(function(e){e.preventDefault(),q();let t=parseInt($("#quantity").val())||1,i=$("#selected-variant-id").val();if(b.length===0){t<99?($("#quantity").val(t+1),$("#summary-qty").text(t+1),m()):f("Maximum quantity: 99 items");return}if(!i){f("\u26A0\uFE0F Please select product options first"),$(".variant-chips-container").css({border:"2px solid #ff6b6b",padding:"10px","border-radius":"8px"}),setTimeout(()=>{$(".variant-chips-container").css("border","none")},2e3);return}s>0?t<s?($("#quantity").val(t+1),$("#summary-qty").text(t+1),m()):(f(`Maximum available: ${s} items`),$("#quantity").val(s)):f("This item is currently out of stock")}),$("#decrease").click(function(e){e.preventDefault(),q();let t=parseInt($("#quantity").val())||1;t>1?($("#quantity").val(t-1),$("#summary-qty").text(t-1),m()):f("Minimum quantity is 1")}),$("#quantity").on("input change",function(){let e=parseInt($(this).val())||1;if($(this).val(e),e<1){$(this).val(1),f("Minimum quantity is 1");return}if(s>0&&e>s){$(this).val(s),f(`Maximum available: ${s} items`);return}if(e>99){$(this).val(99),f("Maximum quantity: 99 items");return}$("#summary-qty").text(e),m()}),$("#quantity").on("keypress",function(e){(e.which<48||e.which>57)&&e.preventDefault()}),$("#order-form").submit(function(e){if(e.preventDefault(),$(".input-error").removeClass("input-error"),$(".variant-chips-container").css({border:"none",padding:"0"}),c){Swal.fire({title:"Please wait",text:"Validating email address...",icon:"info",timer:1500,showConfirmButton:!1});return}let t=!0,i=null;if($("#selected-variant-id").val()||(t=!1,$(".variant-chips-container").css({border:"2px solid #dc3545",padding:"5px","border-radius":"5px"}),i=$(".variant-selection-area")),$(this).find("input[required], select[required], textarea[required]").filter(":visible").each(function(){$(this).prop("disabled")||(!$(this).val()||$(this).val().trim()==="")&&(t=!1,$(this).addClass("input-error"),i||(i=$(this)))}),!t||i){if(i&&i.length){const a=i[0].getBoundingClientRect().top+window.scrollY;$("html, body").animate({scrollTop:a-120},600),i.is("input, select, textarea")&&i.focus()}return}let r=parseInt($("#quantity").val());if(s>0&&r>s){$("#stock-error-message").text(`ERROR: Requested quantity (${r}) exceeds stock limit (${s}).`),$("html, body").animate({scrollTop:$("#quantity").offset().top-150},400);return}const l=$("#email-status");if(l.is(":visible")&&l.text().includes("\u2717")){$("html, body").animate({scrollTop:$("#customerEmail").offset().top-120},300),$("#customerEmail").focus();return}let d={};$(this).serializeArray().forEach(function(a){d[a.name]=a.value}),d.TargetCompanyId=1,d.ProductVariantId=parseInt(d.ProductVariantId),d.OrderQuantity=parseInt(d.OrderQuantity);let v=$(".submit-btn");v.prop("disabled",!0).text("Processing..."),$.ajax({url:"/order/place",type:"POST",contentType:"application/json",data:JSON.stringify(d),success:function(a){a.success?Swal.fire({title:"Success!",text:"Order Placed Successfully! Order ID: "+(a.orderId||"Check DB"),icon:"success",confirmButtonText:"OK",confirmButtonColor:"#2563eb"}).then(C=>{location.reload()}):(Swal.fire({title:"Order Failed",text:a.message||"Failed to place order.",icon:"error",confirmButtonText:"Try Again"}),v.prop("disabled",!1).text("Confirm Order"))},error:function(a){let C="Network Error.";a.responseJSON&&a.responseJSON.message?C=a.responseJSON.message:a.responseText&&(C=a.responseText.substring(0,200)),Swal.fire({title:"Server Error",text:C,icon:"error",confirmButtonText:"Close"}),v.prop("disabled",!1).text("Confirm Order")}})});let x=0;window.changeSlide=function(e){const t=document.querySelectorAll(".slide");t.length!==0&&(t[x].classList.remove("active"),x=(x+e+t.length)%t.length,t[x].classList.add("active"))};const O=document.querySelectorAll(".slide");O.length>0&&O[0].classList.add("active")}),$('input[name="PostalCode"]').on("input keyup blur",function(){let p=$(this).val().trim();if(p.length===4){let o=$(this);o.css("border-color","#3498db"),$.get("/order/check-postal-code",{code:p},function(s){s.found?(o.css("border-color","#2ecc71"),$("#division-select").val(s.division).trigger("change"),setTimeout(()=>{$("#district-select").val(s.district).trigger("change")},500),setTimeout(()=>{if(s.thana&&$("#thana-select").empty().append(`<option value="${s.thana}" selected>${s.thana}</option>`).prop("disabled",!1),s.subOffice){let c=$("#suboffice-select");c.empty().append(`<option value="${s.subOffice}" selected>${s.subOffice}</option>`),c.find(":selected").data("code",p),c.prop("disabled",!1)}},800)):o.css("border-color","#e74c3c")})}});
