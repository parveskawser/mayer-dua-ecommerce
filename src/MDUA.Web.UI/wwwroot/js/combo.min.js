window.OrderAPI={checkCustomer:async function(a){try{const r=await fetch(`/order/check-customer?phone=${a}`);return r.ok?await r.json():{found:!1}}catch(r){return console.error("API Error:",r),{found:!1}}},checkPostalCode:async function(a){try{const r=await fetch(`/order/check-postal-code?code=${a}`);return r.ok?await r.json():{found:!1}}catch{return{found:!1}}},getDivisions:async function(){try{return await(await fetch("/order/get-divisions")).json()}catch{return[]}},getDistricts:async function(a){try{return await(await fetch(`/order/get-districts?division=${a}`)).json()}catch{return[]}},getThanas:async function(a){try{return await(await fetch(`/order/get-thanas?district=${a}`)).json()}catch{return[]}},getSubOffices:async function(a){try{return await(await fetch(`/order/get-suboffices?thana=${a}`)).json()}catch{return[]}}},$(document).ready(function(){if($("#order-form").length===0)return;const a=window.baseProductInfo||{price:0,image:"/images/default-product.jpg"};let r=a.price,s=0,f={},c=!1,b=!1,h=null;const S=typeof deliveryCharges<"u"?deliveryCharges:{dhaka:0,outside:0},C=a.image;$("#display-price").text("Tk. "+r.toLocaleString()),$("#summary-subtotal").text("Tk. "+r.toLocaleString());function E(e,t){let i;return function(){const o=this,l=arguments;clearTimeout(i),i=setTimeout(()=>e.apply(o,l),t)}}const g=window.productVariants||[];if(g.length===1){const e=g[0];k(e),$(".variant-chip").addClass("selected"),e.attributes&&(f={...e.attributes})}$(document).on("click",".variant-chip",function(){let e=$(this),t=e.data("attribute"),i=e.data("value");e.hasClass("selected")?(e.removeClass("selected"),delete f[t]):($(`.variant-chip[data-attribute='${t}']`).removeClass("selected"),e.addClass("selected"),f[t]=i),I()});function I(){$("#selected-variant-id").val("");const e=g.find(t=>{for(let i in f)if(!t.attributes[i]||String(t.attributes[i])!==String(f[i]))return!1;return!0});e?Object.keys(f).length>0?k(e):P():D()}function k(e){$("#selected-variant-id").val(e.id),r=e.price,$("#display-price").text("Tk. "+r.toLocaleString()),s=e.stock;let t=parseInt($("#quantity").val())||1;s>0&&t>s&&$("#quantity").val(s),T(s);let i=e.image&&e.image.length>1?e.image:C;!i.startsWith("/")&&!i.startsWith("http")&&(i="/"+i),$("#order-variant-image").attr("src",i),$(".variant-chips-container").css("border","none"),m(),!c&&!$("#email-status").is(":visible")&&$(".submit-btn").prop("disabled",!1)}function P(){r=a.price,$("#display-price").text("Tk. "+r.toLocaleString()),$("#order-variant-image").attr("src",C),$("#selected-variant-id").val(""),s=0,$("#variant-info").hide(),T(0),m()}function D(){$("#stock-message").text("This combination is currently unavailable.").addClass("text-danger show"),$("#order-variant-image").attr("src",C),$("#selected-variant-id").val(""),s=0}function T(e){const t=$("#stock-message"),i=$("#variant-info");if(t.removeClass("stock-high stock-medium stock-low text-danger show text-success"),Object.keys(f).length===0&&g.length>1){i.hide();return}i.show(),e<=0?(t.text("Out of Stock").addClass("text-danger show"),$(".submit-btn").prop("disabled",!0).text("Out of Stock")):(t.text(`Current Stock: ${e} items available`).addClass("text-success show").css({"font-weight":"bold",color:"#10b981","font-size":"0.95rem"}),c||$(".submit-btn").prop("disabled",!1).text("Confirm Order"))}function p(e){const t=$("#stock-error-message");t.text(e).addClass("show"),setTimeout(()=>{t.removeClass("show")},3e3)}function q(){$("#stock-error-message").text("").removeClass("show")}$("#customerEmail").on("input",function(){b=!1,$("#email-status").hide(),$(".submit-btn").prop("disabled",!1).text("Confirm Order")}),$("#customerEmail").on("blur",function(){const e=$(this).val().trim(),t=$("#email-status");if(t.hide().removeClass("text-danger").removeClass("text-success"),!e){$(".submit-btn").prop("disabled",!1).text("Confirm Order");return}if(b&&e===h){t.text("\u2713 Using your registered email").css("color","green").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order");return}if(!e.includes("@")){t.text("\u26A0 Please enter a valid email address").css("color","orange").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order");return}c=!0,t.text("\u23F3 Checking email...").css("color","blue").show(),$(".submit-btn").prop("disabled",!0).text("Verifying..."),$.get("/order/check-email",{email:e},function(i){c=!1,i.exists?(e===h?t.text("\u2713 Using your registered email").css("color","green").show():t.text("\u2713 Account found! We will link this order to you.").css("color","blue").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order")):(t.text("\u2713 Email available").css("color","green").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order"))}).fail(function(){c=!1,t.text("\u26A0 Could not verify email, but you can proceed.").css("color","orange").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order")})}),$("#customerPhone").on("input",E(function(){let e=$(this).val();e.length>=11?($("#phone-status").text("\u23F3 Checking...").css("color","blue"),window.OrderAPI.checkCustomer(e).then(function(t){if(t.found){if($("#phone-status").text("\u2713 Welcome back! Info loaded.").css("color","green"),t.name&&$("#customerName").val(t.name),t.email){const i=$("#customerEmail"),o=i.val().trim();!o||o.includes("@guest.local")?(b=!0,h=t.email,i.val(t.email),$("#email-status").text("\u2713 Using your registered email").css("color","green").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order")):h=t.email}}else $("#phone-status").text("New Customer").css("color","#666"),b=!1,h=null}).fail(function(){$("#phone-status").text("\u26A0 Could not verify phone").css("color","orange")})):($("#phone-status").text(""),b=!1,h=null)},500));function u(e,t){$(e).empty().append(`<option value="">${t}</option>`).prop("disabled",!0)}function y(e,t,i){let o=$(e);if(o.empty().append(`<option value="">${i}</option>`),!t||t.length===0){o.append('<option value="" disabled>No options available</option>'),o.prop("disabled",!1);return}t.forEach(l=>{let d=l.name||l.Name||l,v=l.name||l.Name||l,n=l.code||l.Code||"";o.append(`<option value="${d}" data-code="${n}">${v}</option>`)}),o.prop("disabled",!1)}function A(){$.get("/order/get-divisions",function(e){y("#division-select",e,"Select Division")}).fail(function(){$("#division-select").append("<option>Error loading data</option>")})}A(),$("#division-select").change(function(){let e=$(this).val();u("#district-select","Loading..."),u("#thana-select","Select District first"),u("#suboffice-select","Select Thana first"),e?$.get("/order/get-districts",{division:e},function(t){y("#district-select",t,"Select District")}).fail(function(){u("#district-select","Error loading districts"),$("#district-select").prop("disabled",!1)}):u("#district-select","Select Division first")}),$("#district-select").change(function(){let e=$(this).val();u("#thana-select","Loading..."),u("#suboffice-select","Select Thana first");let t=S.outside;e&&(e.toLowerCase().includes("dhaka")||e.trim()==="Dhaka")&&(t=S.dhaka),$("#receipt-delivery").text("Tk. "+t).data("cost",t),m(),e?$.get("/order/get-thanas",{district:e},function(i){y("#thana-select",i,"Select Thana")}).fail(function(){u("#thana-select","Error loading thanas"),$("#thana-select").prop("disabled",!1)}):u("#thana-select","Select District first")}),$("#thana-select").change(function(){let e=$(this).val();u("#suboffice-select","Loading..."),e?$.get("/order/get-suboffices",{thana:e},function(t){y("#suboffice-select",t,"Select Sub-Office")}).fail(function(){u("#suboffice-select","Error loading sub-offices"),$("#suboffice-select").prop("disabled",!1)}):u("#suboffice-select","Select Thana first")}),$("#suboffice-select").change(function(){let e=$(this).find(":selected").data("code");e&&$('input[name="PostalCode"]').val()!=e&&$('input[name="PostalCode"]').val(e).css("border-color","#2ecc71")});function m(){let e=parseInt($("#quantity").val())||1,t=r*e,i=parseFloat($("#receipt-delivery").data("cost"))||0,o=t+i;$("#summary-qty").text(e),$("#summary-subtotal").text("Tk. "+t.toLocaleString()),$("#receipt-grand-total").text("Tk. "+o.toLocaleString())}$("#increase").click(function(e){e.preventDefault(),q();let t=parseInt($("#quantity").val())||1,i=$("#selected-variant-id").val();if(g.length===0){t<99?($("#quantity").val(t+1),$("#summary-qty").text(t+1),m()):p("Maximum quantity: 99 items");return}if(!i){p("\u26A0\uFE0F Please select product options first"),$(".variant-chips-container").css({border:"2px solid #ff6b6b",padding:"10px","border-radius":"8px"}),setTimeout(()=>{$(".variant-chips-container").css("border","none")},2e3);return}s>0?t<s?($("#quantity").val(t+1),$("#summary-qty").text(t+1),m()):(p(`Maximum available: ${s} items`),$("#quantity").val(s)):p("This item is currently out of stock")}),$("#decrease").click(function(e){e.preventDefault(),q();let t=parseInt($("#quantity").val())||1;t>1?($("#quantity").val(t-1),$("#summary-qty").text(t-1),m()):p("Minimum quantity is 1")}),$("#quantity").on("input change",function(){let e=parseInt($(this).val())||1;if($(this).val(e),e<1){$(this).val(1),p("Minimum quantity is 1");return}if(s>0&&e>s){$(this).val(s),p(`Maximum available: ${s} items`);return}if(e>99){$(this).val(99),p("Maximum quantity: 99 items");return}$("#summary-qty").text(e),m()}),$("#quantity").on("keypress",function(e){(e.which<48||e.which>57)&&e.preventDefault()}),$("#order-form").submit(function(e){if(e.preventDefault(),$(".input-error").removeClass("input-error"),$(".variant-chips-container").css({border:"none",padding:"0"}),c){Swal.fire({title:"Please wait",text:"Validating email address...",icon:"info",timer:1500,showConfirmButton:!1});return}let t=!0,i=null;if($("#selected-variant-id").val()||(t=!1,$(".variant-chips-container").css({border:"2px solid #dc3545",padding:"5px","border-radius":"5px"}),i=$(".variant-selection-area")),$(this).find("input[required], select[required], textarea[required]").filter(":visible").each(function(){$(this).prop("disabled")||(!$(this).val()||$(this).val().trim()==="")&&(t=!1,$(this).addClass("input-error"),i||(i=$(this)))}),!t||i){if(i&&i.length){const n=i[0].getBoundingClientRect().top+window.scrollY;$("html, body").animate({scrollTop:n-120},600),i.is("input, select, textarea")&&i.focus()}return}let o=parseInt($("#quantity").val());if(s>0&&o>s){$("#stock-error-message").text(`ERROR: Requested quantity (${o}) exceeds stock limit (${s}).`),$("html, body").animate({scrollTop:$("#quantity").offset().top-150},400);return}const l=$("#email-status");if(l.is(":visible")&&l.text().includes("\u2717")){$("html, body").animate({scrollTop:$("#customerEmail").offset().top-120},300),$("#customerEmail").focus();return}let d={};$(this).serializeArray().forEach(function(n){d[n.name]=n.value}),d.TargetCompanyId=1,d.ProductVariantId=parseInt(d.ProductVariantId),d.OrderQuantity=parseInt(d.OrderQuantity);let v=$(".submit-btn");v.prop("disabled",!0).text("Processing..."),$.ajax({url:"/order/place",type:"POST",contentType:"application/json",data:JSON.stringify(d),success:function(n){n.success?Swal.fire({title:"Success!",text:"Order Placed Successfully! Order ID: "+(n.orderId||"Check DB"),icon:"success",confirmButtonText:"OK",confirmButtonColor:"#2563eb"}).then(w=>{location.reload()}):(Swal.fire({title:"Order Failed",text:n.message||"Failed to place order.",icon:"error",confirmButtonText:"Try Again"}),v.prop("disabled",!1).text("Confirm Order"))},error:function(n){let w="Network Error.";n.responseJSON&&n.responseJSON.message?w=n.responseJSON.message:n.responseText&&(w=n.responseText.substring(0,200)),Swal.fire({title:"Server Error",text:w,icon:"error",confirmButtonText:"Close"}),v.prop("disabled",!1).text("Confirm Order")}})});let x=0;window.changeSlide=function(e){const t=document.querySelectorAll(".slide");t.length!==0&&(t[x].classList.remove("active"),x=(x+e+t.length)%t.length,t[x].classList.add("active"))};const O=document.querySelectorAll(".slide");O.length>0&&O[0].classList.add("active")}),$('input[name="PostalCode"]').on("input keyup blur",function(){let a=$(this).val().trim();if(a.length===4){let r=$(this);r.css("border-color","#3498db"),$.get("/order/check-postal-code",{code:a},function(s){s.found?(r.css("border-color","#2ecc71"),$("#division-select").val(s.division).trigger("change"),setTimeout(()=>{$("#district-select").val(s.district).trigger("change")},500),setTimeout(()=>{if(s.thana&&$("#thana-select").empty().append(`<option value="${s.thana}" selected>${s.thana}</option>`).prop("disabled",!1),s.subOffice){let c=$("#suboffice-select");c.empty().append(`<option value="${s.subOffice}" selected>${s.subOffice}</option>`),c.find(":selected").data("code",a),c.prop("disabled",!1)}},800)):r.css("border-color","#e74c3c")})}});
