window.OrderAPI={checkCustomer:async function(n){try{const o=await fetch(`/order/check-customer?phone=${n}`);return o.ok?await o.json():{found:!1}}catch(o){return console.error("API Error:",o),{found:!1}}},checkPostalCode:async function(n){try{const o=await fetch(`/order/check-postal-code?code=${n}`);return o.ok?await o.json():{found:!1}}catch{return{found:!1}}},getDivisions:async function(){try{return await(await fetch("/order/get-divisions")).json()}catch{return[]}},getDistricts:async function(n){try{return await(await fetch(`/order/get-districts?division=${n}`)).json()}catch{return[]}},getThanas:async function(n){try{return await(await fetch(`/order/get-thanas?district=${n}`)).json()}catch{return[]}},getSubOffices:async function(n){try{return await(await fetch(`/order/get-suboffices?thana=${n}`)).json()}catch{return[]}}},$(document).ready(function(){if($("#order-form").length===0)return;$(".payment-option").on("click",function(){$(".payment-option").removeClass("selected"),$(this).addClass("selected"),$(this).find('input[type="radio"]').prop("checked",!0),n()}),$('input[name="paymentMethod"]').on("change",function(){$(".payment-option").removeClass("selected"),$(this).closest(".payment-option").addClass("selected"),n()});function n(){const e=$('input[name="paymentMethod"]:checked').val(),t=$("#final-submit-btn"),i=$("#receipt-grand-total").text();e==="cod"?t.text("Confirm Order"):t.text(`Proceed and Pay ${i}`)}n();const o=p;p=function(){o(),n()};const d=window.baseProductInfo||{price:0,image:"/images/default-product.jpg"};let h=d.price,a=0,f={},v=!1,x=!1,b=null;const T=typeof deliveryCharges<"u"?deliveryCharges:{dhaka:0,outside:0},C=d.image;$("#display-price").text("Tk. "+h.toLocaleString()),$("#summary-subtotal").text("Tk. "+h.toLocaleString());function D(e,t){let i;return function(){const s=this,l=arguments;clearTimeout(i),i=setTimeout(()=>e.apply(s,l),t)}}const y=window.productVariants||[];if(y.length===1){const e=y[0];q(e),$(".variant-chip").addClass("selected"),e.attributes&&(f={...e.attributes})}$(document).on("click",".variant-chip",function(){let e=$(this),t=e.data("attribute"),i=e.data("value");e.hasClass("selected")?(e.removeClass("selected"),delete f[t]):($(`.variant-chip[data-attribute='${t}']`).removeClass("selected"),e.addClass("selected"),f[t]=i),O(),A()});function O(){$(".variant-chip").each(function(){const e=$(this),t=e.data("attribute"),i=e.data("value");if(e.hasClass("selected")){e.removeClass("disabled");return}const s={...f};delete s[t],s[t]=i,y.some(c=>{for(const[m,r]of Object.entries(s))if(!c.attributes||c.attributes[m]!==r)return!1;return!0})?e.removeClass("disabled"):e.addClass("disabled")})}O();function A(){$("#selected-variant-id").val("");const e=y.find(t=>{const i=Object.keys(t.attributes),s=Object.keys(f);if(i.length!==s.length)return!1;for(let l of s)if(!t.attributes.hasOwnProperty(l)||t.attributes[l]!==f[l])return!1;return!0});e?Object.keys(f).length>0?q(e):M():j()}function q(e){$("#selected-variant-id").val(e.id),h=e.price,$("#display-price").text("Tk. "+h.toLocaleString()),a=e.stock;let t=parseInt($("#quantity").val())||1;a>0&&t>a&&$("#quantity").val(a),P(a);let i=e.image&&e.image.length>1?e.image:C;!i.startsWith("/")&&!i.startsWith("http")&&(i="/"+i),$("#order-variant-image").attr("src",i),$("#mobile-order-variant-image").attr("src",i),$(".variant-chips-container").css("border","none"),p(),!v&&!$("#email-status").is(":visible")&&$(".submit-btn").prop("disabled",!1)}function M(){h=d.price,$("#display-price").text("Tk. "+h.toLocaleString()),$("#order-variant-image").attr("src",C),$("#mobile-order-variant-image").attr("src",C),$("#selected-variant-id").val(""),a=0,f={},$(".variant-chip").removeClass("selected"),O(),$("#variant-info").hide(),P(0),p()}function j(){$("#stock-message").text("This combination is currently unavailable.").addClass("text-danger show"),$("#order-variant-image").attr("src",C),$("#mobile-order-variant-image").attr("src",C),$("#selected-variant-id").val(""),a=0}function P(e){const t=$("#stock-message"),i=$("#variant-info");if(t.removeClass("stock-high stock-medium stock-low text-danger show text-success"),Object.keys(f).length===0&&y.length>1){i.hide();return}i.show(),e<=0?(t.text("Out of Stock").addClass("text-danger show"),$(".submit-btn").prop("disabled",!0).text("Out of Stock")):(t.text(`Current Stock: ${e} items available`).addClass("text-success show").css({"font-weight":"bold",color:"#10b981","font-size":"0.95rem"}),v||$(".submit-btn").prop("disabled",!1).text("Confirm Order"))}function g(e){const t=$("#stock-error-message");t.text(e).addClass("show"),setTimeout(()=>{t.removeClass("show")},3e3)}function E(){$("#stock-error-message").text("").removeClass("show")}$("#customerEmail").on("input",function(){x=!1,$("#email-status").hide(),$(".submit-btn").prop("disabled",!1).text("Confirm Order")}),$("#customerEmail").on("blur",function(){const e=$(this).val().trim(),t=$("#email-status");if(t.hide().removeClass("text-danger").removeClass("text-success"),!e){$(".submit-btn").prop("disabled",!1).text("Confirm Order");return}if(x&&e===b){t.text("\u2713 Using your registered email").css("color","green").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order");return}if(!e.includes("@")){t.text("\u26A0 Please enter a valid email address").css("color","orange").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order");return}v=!0,t.text("\u23F3 Checking email...").css("color","blue").show(),$(".submit-btn").prop("disabled",!0).text("Verifying..."),$.get("/order/check-email",{email:e},function(i){v=!1,i.exists?b&&e===b?(t.text("\u2713 Using your registered email").css("color","green").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order")):(t.text("\u26A0 This email is already registered with a different phone number.").css("color","red").show(),$(".submit-btn").prop("disabled",!0).text("Fix Email")):(t.text("\u2713 Email available").css("color","green").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order"))}).fail(function(){v=!1,t.text("\u26A0 Could not verify email, but you can proceed.").css("color","orange").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order")})}),$("#customerPhone").on("input",D(function(){let e=$(this).val();e.length>=11?($("#phone-status").text("\u23F3 Checking...").css("color","blue"),window.OrderAPI.checkCustomer(e).then(function(t){if(t.found)if($("#phone-status").text("\u2713 Welcome back! Info loaded.").css("color","green"),t.name&&$("#customerName").val(t.name),t.email){const i=$("#customerEmail"),s=i.val().trim();!s||s.includes("@guest.local")?(x=!0,b=t.email,i.val(t.email),$("#email-status").text("\u2713 Using your registered email").css("color","green").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order")):b=t.email}else b=null;else $("#phone-status").text("New Customer").css("color","#666"),x=!1,b=null}).fail(function(){$("#phone-status").text("\u26A0 Could not verify phone").css("color","orange")})):($("#phone-status").text(""),x=!1,b=null)},500));function u(e,t){$(e).empty().append(`<option value="">${t}</option>`).prop("disabled",!0)}function w(e,t,i){let s=$(e);if(s.empty().append(`<option value="">${i}</option>`),!t||t.length===0){s.append('<option value="" disabled>No options available</option>'),s.prop("disabled",!1);return}t.forEach(l=>{let c=l.name||l.Name||l,m=l.name||l.Name||l,r=l.code||l.Code||"";s.append(`<option value="${c}" data-code="${r}">${m}</option>`)}),s.prop("disabled",!1)}function V(){$.get("/order/get-divisions",function(e){w("#division-select",e,"Select Division")}).fail(function(){$("#division-select").append("<option>Error loading data</option>")})}V(),$("#division-select").change(function(){let e=$(this).val();u("#district-select","Loading..."),u("#thana-select","Select District first"),u("#suboffice-select","Select Thana first"),e?$.get("/order/get-districts",{division:e},function(t){w("#district-select",t,"Select District")}).fail(function(){u("#district-select","Error loading districts"),$("#district-select").prop("disabled",!1)}):u("#district-select","Select Division first")}),$("#district-select").change(function(){let e=$(this).val();u("#thana-select","Loading..."),u("#suboffice-select","Select Thana first");let t=T.outside;e&&(e.toLowerCase().includes("dhaka")||e.trim()==="Dhaka")&&(t=T.dhaka),$("#receipt-delivery").text("Tk. "+t).data("cost",t),p(),e?$.get("/order/get-thanas",{district:e},function(i){w("#thana-select",i,"Select Thana")}).fail(function(){u("#thana-select","Error loading thanas"),$("#thana-select").prop("disabled",!1)}):u("#thana-select","Select District first")}),$("#thana-select").change(function(){let e=$(this).val();u("#suboffice-select","Loading..."),e?$.get("/order/get-suboffices",{thana:e},function(t){w("#suboffice-select",t,"Select Sub-Office")}).fail(function(){u("#suboffice-select","Error loading sub-offices"),$("#suboffice-select").prop("disabled",!1)}):u("#suboffice-select","Select Thana first")}),$("#suboffice-select").change(function(){let e=$(this).find(":selected").data("code");e&&$('input[name="PostalCode"]').val()!=e&&$('input[name="PostalCode"]').val(e).css("border-color","#2ecc71")});function p(){let e=parseInt($("#quantity").val())||1,t=h*e,i=parseFloat($("#receipt-delivery").data("cost"))||0,s=t+i;$("#summary-qty").text(e),$("#summary-subtotal").text("Tk. "+t.toLocaleString()),$("#receipt-grand-total").text("Tk. "+s.toLocaleString())}$("#increase").click(function(e){e.preventDefault(),E();let t=parseInt($("#quantity").val())||1,i=$("#selected-variant-id").val();if(y.length===0){t<99?($("#quantity").val(t+1),$("#summary-qty").text(t+1),p()):g("Maximum quantity: 99 items");return}if(!i){g("\u26A0\uFE0F Please select product options first"),$(".variant-chips-container").css({border:"2px solid #ff6b6b",padding:"10px","border-radius":"8px"}),setTimeout(()=>{$(".variant-chips-container").css("border","none")},2e3);return}a>0?t<a?($("#quantity").val(t+1),$("#summary-qty").text(t+1),p()):(g(`Maximum available: ${a} items`),$("#quantity").val(a)):g("This item is currently out of stock")}),$("#decrease").click(function(e){e.preventDefault(),E();let t=parseInt($("#quantity").val())||1;t>1?($("#quantity").val(t-1),$("#summary-qty").text(t-1),p()):g("Minimum quantity is 1")}),$("#quantity").on("input change",function(){let e=parseInt($(this).val())||1;if($(this).val(e),e<1){$(this).val(1),g("Minimum quantity is 1");return}if(a>0&&e>a){$(this).val(a),g(`Maximum available: ${a} items`);return}if(e>99){$(this).val(99),g("Maximum quantity: 99 items");return}$("#summary-qty").text(e),p()}),$("#quantity").on("keypress",function(e){(e.which<48||e.which>57)&&e.preventDefault()}),$("#order-form").submit(function(e){if(e.preventDefault(),$(".input-error").removeClass("input-error"),$(".variant-chips-container").css({border:"none",padding:"0"}),v){Swal.fire({title:"Please wait",text:"Validating email address...",icon:"info",timer:1500,showConfirmButton:!1});return}const t=$("#email-status");if(t.is(":visible")&&t.css("color")==="rgb(255, 0, 0)"){$("html, body").animate({scrollTop:$("#customerEmail").offset().top-120},300),$("#customerEmail").focus();return}let i=!0,s=null;if($("#selected-variant-id").val()||(i=!1,$(".variant-chips-container").css({border:"2px solid #dc3545",padding:"5px","border-radius":"5px"}),s=$(".variant-selection-area")),$(this).find("input[required], select[required], textarea[required]").filter(":visible").each(function(){$(this).prop("disabled")||(!$(this).val()||$(this).val().trim()==="")&&(i=!1,$(this).addClass("input-error"),s||(s=$(this)))}),!i||s){if(s&&s.length){const r=s[0].getBoundingClientRect().top+window.scrollY;$("html, body").animate({scrollTop:r-120},600)}return}let l=parseInt($("#quantity").val());if(a>0&&l>a){$("#stock-error-message").text("ERROR: Requested quantity exceeds limit.");return}let c={};$(this).serializeArray().forEach(function(r){c[r.name]=r.value}),c.PaymentMethod=$('input[name="paymentMethod"]:checked').val()||"cod",c.TargetCompanyId=1,c.ProductVariantId=parseInt(c.ProductVariantId),c.OrderQuantity=parseInt(c.OrderQuantity);let m=$("#final-submit-btn");m.prop("disabled",!0),c.PaymentMethod==="cod"?m.text("Processing..."):m.text("Redirecting..."),$.ajax({url:"/order/place",type:"POST",contentType:"application/json",data:JSON.stringify(c),success:function(r){r.success?c.PaymentMethod==="cod"?Swal.fire({title:"Success!",text:"Order Placed Successfully! Order ID: "+(r.orderId||"Check DB"),icon:"success",confirmButtonText:"OK",confirmButtonColor:"#2563eb"}).then(S=>{location.reload()}):r.paymentUrl?window.location.href=r.paymentUrl:Swal.fire({title:"Payment Pending",text:"Order created. Redirecting to payment...",icon:"info",confirmButtonText:"OK"}).then(()=>{location.reload()}):(Swal.fire({title:"Order Failed",text:r.message||"Failed to place order.",icon:"error",confirmButtonText:"Try Again"}),m.prop("disabled",!1),n())},error:function(r){let S="Network Error.";r.responseJSON&&r.responseJSON.message?S=r.responseJSON.message:r.responseText&&(S=r.responseText.substring(0,200)),Swal.fire({title:"Server Error",text:S,icon:"error",confirmButtonText:"Close"}),m.prop("disabled",!1),n()}})});let k=0;window.changeSlide=function(e){const t=document.querySelectorAll(".slide");t.length!==0&&(t[k].classList.remove("active"),k=(k+e+t.length)%t.length,t[k].classList.add("active"))};const I=document.querySelectorAll(".slide");I.length>0&&I[0].classList.add("active")}),$('input[name="PostalCode"]').on("input keyup blur",function(){let n=$(this).val().trim();if(n.length===4){let o=$(this);o.css("border-color","#3498db"),$.get("/order/check-postal-code",{code:n},function(d){d.found?(o.css("border-color","#2ecc71"),$("#division-select").val(d.division).trigger("change"),setTimeout(()=>{$("#district-select").val(d.district).trigger("change")},500),setTimeout(()=>{if(d.thana&&$("#thana-select").empty().append(`<option value="${d.thana}" selected>${d.thana}</option>`).prop("disabled",!1),d.subOffice){let a=$("#suboffice-select");a.empty().append(`<option value="${d.subOffice}" selected>${d.subOffice}</option>`),a.find(":selected").data("code",n),a.prop("disabled",!1)}},800)):o.css("border-color","#e74c3c")})}});
