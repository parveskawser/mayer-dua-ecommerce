$(document).ready(function(){let u=$("#addProductModal #attributes-container .attribute-row").length;function d(){let t=[];$("#addProductModal .attribute-select").each(function(){let e=$(this).val();e&&t.push(e)}),$("#addProductModal .attribute-select").each(function(){let e=$(this).val();$(this).find("option").each(function(){let a=$(this).val();a&&(t.includes(a)&&a!==e?$(this).prop("disabled",!0):$(this).prop("disabled",!1))})})}function h(t){return t.reduce((e,a)=>e.flatMap(r=>a.map(l=>r.concat([l]))),[[]])}$("#addProductModal").on("click","#add-attribute",function(){let t=$("#addProductModal #attributes-container .attribute-row:first-child select").html(),e=`
            <div class="attribute-row mb-2" data-attr-index="${u}">
                <select name="Attributes[${u}].AttributeId" 
                        class="attribute-select form-control-modal">
                    ${t}
                </select>
                <div class="attribute-values-container mt-2"></div>
                <button type="button" 
                    class="btn btn-sm btn-outline-danger remove-attribute mt-1">x</button>
            </div>
        `;$("#addProductModal #attributes-container").append(e),u++,d()}),$("#addProductModal").on("click",".remove-attribute",function(){$(this).closest(".attribute-row").remove(),d(),c()}),$("#addProductModal").on("change",".attribute-select",function(){let t=$(this),a=t.closest(".attribute-row").find(".attribute-values-container"),r=t.val();if(a.empty(),!r){d();return}a.html('<div class="text-muted small fst-italic">Loading values...</div>');let l=window.productConfig&&window.productConfig.urls?window.productConfig.urls.getAttributeValues:"/Product/GetAttributeValues";$.ajax({url:l,type:"GET",data:{attributeId:r},success:function(i){if(a.empty(),!i||i.length===0){a.html('<span class="text-muted small">No values found.</span>');return}i.forEach(n=>{let o=n.id||n.Id,s=n.value||n.Value||n.name||n.Name;a.append(`
                    <div class="form-check">
                        <input type="checkbox" 
                               class="form-check-input attribute-value-checkbox" 
                               id="attr_val_${o}"
                               value="${o}" 
                               data-attrname="${s}" />
                        <label class="form-check-label" for="attr_val_${o}">
                            ${s}
                        </label>
                    </div>
                `)}),d()},error:function(i,n,o){console.error("Error loading attributes:",o),a.html('<span class="text-danger small">Error loading data.</span>')}})}),$("#addProductModal").on("change",".attribute-value-checkbox",c);function c(){let t=$("#addProductModal #variants-container");t.html("");let e=[];if($("#addProductModal .attribute-row").each(function(){let i=$(this).find(".attribute-value-checkbox:checked");if(i.length>0){let n=[];i.each(function(){n.push({id:$(this).val(),label:$(this).data("attrname")})}),e.push(n)}}),e.length===0)return;let a=h(e),r=$("input[name='ProductName']").val()||"",l=$("#addProductModal input[name='BasePrice']").val()||0;a.length>0&&t.append(`
                <div class="variant-header-row mb-1 d-flex">
                    <span class="w-50" style="font-weight: bold;">Variant Name</span>
                    <span class="w-50" style="font-weight: bold;">Variant Price</span>
                </div>
            `),a.forEach((i,n)=>{let o=r+" - "+i.map(m=>m.label).join(" - "),s=i.map((m,v)=>`<input type="hidden" 
                        name="Variants[${n}].AttributeValueIds[${v}]"
                        value="${m.id}" />`).join("");t.append(`
                <div class="variant-row mb-2 d-flex align-items-center">
                    ${s}
                    <input type="hidden" name="Variants[${n}].VariantName" value="${o}" />
                    
                    <span class="w-50">${o}</span>
                    
                    <div class="w-50 d-flex align-items-center">
                        
                        <span class="me-1">Tk.</span> 
                        
                        <input type="number" 
                               name="Variants[${n}].VariantPrice"
                               class="form-control-modal" style="width: 100px;" 
                               value="${l}"
                               required />
                        
                        <button type="button" class="btn btn-sm btn-outline-danger remove-variant ms-2" 
                                style="line-height: 1; padding: 0.25rem 0.5rem;">
                                &times;
                        </button>
                    </div>
                </div>
            `)})}$("#addProductModal input[name='ProductName']").on("input",c),$("#addProductModal").on("click",".remove-variant",function(){$(this).closest(".variant-row").remove();let t=$("#addProductModal #variants-container .variant-row");t.each(function(e){$(this).find("input").each(function(){let r=$(this),l=r.attr("name");if(l){let i=l.replace(/^(Variants\[)\d+/,`$1${e}`);r.attr("name",i)}})}),t.length===0&&$("#addProductModal #variants-container .variant-header-row").remove()}),$("#addProductModal").on("hidden.bs.modal",function(){let t=$(this).find("form");t[0].reset(),t.find(".attribute-row:not(:first)").remove(),t.find(".attribute-values-container").html(""),t.find("#variants-container").html(""),d()}),$("#addProductModal").on("keydown","input",function(t){(t.key==="Enter"||t.keyCode===13)&&t.preventDefault()});const b=$('input[name="ProductName"]'),p=$('input[name="Slug"]');let f=!1;p.on("input",function(){$(this).val().trim()!==""&&(f=!0)}),b.on("input",function(){if(!f){const e=$(this).val().toLowerCase().replace(/[^a-z0-9\s-]/g,"").trim().replace(/\s+/g,"-").replace(/-+/g,"-");p.val(e)}})});
