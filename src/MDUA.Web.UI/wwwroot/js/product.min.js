$(document).ready(function(){let d=$("#addProductModal #attributes-container .attribute-row").length;function l(){let t=[];$("#addProductModal .attribute-select").each(function(){let e=$(this).val();e&&t.push(e)}),$("#addProductModal .attribute-select").each(function(){let e=$(this).val();$(this).find("option").each(function(){let a=$(this).val();a&&(t.includes(a)&&a!==e?$(this).prop("disabled",!0):$(this).prop("disabled",!1))})})}function b(t){return t.reduce((e,a)=>e.flatMap(i=>a.map(n=>i.concat([n]))),[[]])}$("#addProductModal").on("click","#add-attribute",function(){let t=$("#addProductModal #attributes-container .attribute-row:first-child select").html(),e=`
            <div class="attribute-row mb-2" data-attr-index="${d}">
                <select name="Attributes[${d}].AttributeId" 
                        class="attribute-select form-control-modal">
                    ${t}
                </select>
                <div class="attribute-values-container mt-2"></div>
                <button type="button" 
                    class="btn btn-sm btn-outline-danger remove-attribute mt-1">x</button>
            </div>
        `;$("#addProductModal #attributes-container").append(e),d++,l()}),$("#addProductModal").on("click",".remove-attribute",function(){$(this).closest(".attribute-row").remove(),l(),u()}),$("#addProductModal").on("change",".attribute-select",function(){let e=$(this).closest(".attribute-row").find(".attribute-values-container");e.html(""),l();let a=$(this).val();a&&$.get("/product/get-attribute-values",{attributeId:a},function(i){i.forEach(n=>{e.append(`
                    <label class="d-block">
                        <input type="checkbox" 
                               class="attribute-value-checkbox" 
                               value="${n.id}" 
                               data-attrname="${n.value}" />
                        ${n.value}
                    </label>
                `)})})}),$("#addProductModal").on("change",".attribute-value-checkbox",u);function u(){let t=$("#addProductModal #variants-container");t.html("");let e=[];if($("#addProductModal .attribute-row").each(function(){let r=$(this).find(".attribute-value-checkbox:checked");if(r.length>0){let o=[];r.each(function(){o.push({id:$(this).val(),label:$(this).data("attrname")})}),e.push(o)}}),e.length===0)return;let a=b(e),i=$("input[name='ProductName']").val()||"",n=$("#addProductModal input[name='BasePrice']").val()||0;a.length>0&&t.append(`
                <div class="variant-header-row mb-1 d-flex">
                    <span class="w-50" style="font-weight: bold;">Variant Name</span>
                    <span class="w-50" style="font-weight: bold;">Variant Price</span>
                </div>
            `),a.forEach((r,o)=>{let p=i+" - "+r.map(c=>c.label).join(" - "),f=r.map((c,v)=>`<input type="hidden" 
                        name="Variants[${o}].AttributeValueIds[${v}]"
                        value="${c.id}" />`).join("");t.append(`
                <div class="variant-row mb-2 d-flex align-items-center">
                    ${f}
                    <input type="hidden" name="Variants[${o}].VariantName" value="${p}" />
                    
                    <span class="w-50">${p}</span>
                    
                    <div class="w-50 d-flex align-items-center">
                        
                        <span class="me-1">Tk.</span> 
                        
                        <input type="number" 
                               name="Variants[${o}].VariantPrice"
                               class="form-control-modal" style="width: 100px;" 
                               value="${n}"
                               required />
                        
                        <button type="button" class="btn btn-sm btn-outline-danger remove-variant ms-2" 
                                style="line-height: 1; padding: 0.25rem 0.5rem;">
                                &times;
                        </button>
                    </div>
                </div>
            `)})}$("#addProductModal input[name='ProductName']").on("input",u),$("#addProductModal").on("click",".remove-variant",function(){$(this).closest(".variant-row").remove();let t=$("#addProductModal #variants-container .variant-row");t.each(function(e){$(this).find("input").each(function(){let i=$(this),n=i.attr("name");if(n){let r=n.replace(/^(Variants\[)\d+/,`$1${e}`);i.attr("name",r)}})}),t.length===0&&$("#addProductModal #variants-container .variant-header-row").remove()}),$("#addProductModal").on("hidden.bs.modal",function(){let t=$(this).find("form");t[0].reset(),t.find(".attribute-row:not(:first)").remove(),t.find(".attribute-values-container").html(""),t.find("#variants-container").html(""),l()}),$("#addProductModal").on("keydown","input",function(t){(t.key==="Enter"||t.keyCode===13)&&t.preventDefault()});const h=$('input[name="ProductName"]'),s=$('input[name="Slug"]');let m=!1;s.on("input",function(){$(this).val().trim()!==""&&(m=!0)}),h.on("input",function(){if(!m){const e=$(this).val().toLowerCase().replace(/[^a-z0-9\s-]/g,"").trim().replace(/\s+/g,"-").replace(/-+/g,"-");s.val(e)}})});
