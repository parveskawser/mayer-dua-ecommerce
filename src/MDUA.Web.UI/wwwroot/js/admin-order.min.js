document.addEventListener("DOMContentLoaded",function(){console.log("Admin Order Script Loaded");const O=document.getElementById("productSelect"),i=document.getElementById("variantSelect"),h=document.getElementById("orderQty"),r=document.getElementById("stockInfo"),x=document.getElementById("displayPrice"),b=document.getElementById("displaySubTotal"),B=document.getElementById("displayDiscount"),v=document.getElementById("displayDelivery"),S=document.getElementById("displayNet"),w=document.getElementById("modeDelivery"),l=document.getElementById("modeStore"),L=document.getElementById("address-container"),c=document.getElementById("division-select"),E=document.getElementById("district-select"),f=document.getElementById("thana-select"),I=document.getElementById("suboffice-select"),k=document.getElementById("postalCode"),A=document.getElementById("postalStatus");function N(){const t=l&&l.checked;L&&(L.style.display=t?"none":"block"),p()}w&&w.addEventListener("change",N),l&&l.addEventListener("change",N);function p(){if(i.disabled||i.selectedIndex===-1){x&&(x.textContent="0.00"),b&&(b.textContent="0.00"),B&&(B.textContent="0.00"),v&&(v.textContent="0.00"),S&&(S.textContent="0.00");return}const t=i.options[i.selectedIndex],e=parseFloat(t.getAttribute("data-price"))||0,n=parseInt(h.value)||1,d=t.getAttribute("data-disc-type")||"None",s=parseFloat(t.getAttribute("data-disc-val"))||0,o=e*n;let a=0;d==="Flat"?a=s*n:d==="Percentage"&&(a=o*(s/100));let u=0;if(l&&l.checked)u=0;else{const V=c&&c.value?c.value.toLowerCase():"";V===""?u=0:V.includes("dhaka")?u=50:u=100}const m=o-a+u;x.textContent=e.toFixed(2),b.textContent=o.toFixed(2),B.textContent=a.toFixed(2),v&&(v.textContent=u.toFixed(2)),S.textContent=m.toFixed(2)}const M=typeof window.rawVariants<"u"&&Array.isArray(window.rawVariants)?window.rawVariants:[],g={};M.forEach(t=>{const e=t.ProductId||t.productId,n=t.ProductName||t.productName;if(e){if(!g[e]){g[e]={name:n,variants:[]};let d=new Option(n,e);O.add(d)}g[e].variants.push(t)}}),O.addEventListener("change",function(){i.innerHTML='<option value="" data-price="0">Select Variant...</option>',i.disabled=!0,r&&(r.textContent=""),p();const t=this.value;t&&g[t]&&(g[t].variants.forEach(e=>{const n=e.VariantId||e.variantId,d=e.VariantName||e.variantName,s=e.Price||e.price||0,o=e.Stock||e.stock||0,a=e.DiscountType||e.discountType||"None",u=e.DiscountValue||e.discountValue||0;let m=new Option(`${d} (Tk. ${s})`,n);m.setAttribute("data-price",s),m.setAttribute("data-stock",o),m.setAttribute("data-disc-type",a),m.setAttribute("data-disc-val",u),i.add(m)}),i.disabled=!1)}),i.addEventListener("change",function(){const e=this.options[this.selectedIndex].getAttribute("data-stock");if(r)if(e){const n=parseInt(e);n>=999?(r.textContent="In Stock",r.className="form-text text-success"):(r.textContent=`Available Stock: ${e}`,r.className=n<5?"form-text text-danger fw-bold":"form-text text-success")}else r.textContent="";p()}),h.addEventListener("input",p),c&&c.addEventListener("change",p);async function C(t,e,n=null){e.innerHTML='<option value="">Loading...</option>',e.disabled=!0;try{const d=await t;e.innerHTML='<option value="">Select...</option>',Array.isArray(d)&&(d.forEach(s=>{let o=s.name||s,a=new Option(o,o);(s.code||s.postalCode)&&a.setAttribute("data-code",s.code||s.postalCode),e.add(a)}),e.disabled=!1,n&&(e.value=n))}catch{e.innerHTML='<option value="">Error</option>'}}window.OrderAPI?C(window.OrderAPI.getDivisions(),c):console.error("OrderAPI missing. combo.js must be loaded first."),c.addEventListener("change",()=>{C(window.OrderAPI.getDistricts(c.value),E),f.innerHTML='<option value="">Select...</option>',f.disabled=!0,I.innerHTML='<option value="">Select...</option>',I.disabled=!0,p()}),E.addEventListener("change",()=>{C(window.OrderAPI.getThanas(E.value),f)}),f.addEventListener("change",()=>{C(window.OrderAPI.getSubOffices(f.value),I)}),I.addEventListener("change",function(){const e=this.options[this.selectedIndex].getAttribute("data-code");e&&k&&(k.value=e,A&&(A.textContent="Code auto-filled",A.className="text-success small"))});const y=document.getElementById("custAddress"),P=document.getElementById("custPhone"),T=document.getElementById("btnCheckCust");T&&T.addEventListener("click",()=>{const t=P.value.trim();t.length<10||window.OrderAPI.checkCustomer(t).then(e=>{if(e.found){document.getElementById("custName").value=e.name||"";const n=document.getElementById("custEmail");n&&(n.value=e.email||"");const d=document.getElementById("custStatus");d&&(d.textContent="Customer found!",d.className="text-success small"),e.addressData&&w.checked&&y&&(y.value=e.addressData.street||"")}else{const n=document.getElementById("custStatus");n&&(n.textContent="New Customer",n.className="text-primary small"),document.getElementById("custName").value="",y&&(y.value="")}})});const D=document.getElementById("btnPlaceOrder");D&&D.addEventListener("click",function(){const t=this,e=document.getElementById("orderMsg"),n=l&&l.checked;if(!P.value||!document.getElementById("custName").value||!i.value){alert("Please fill in Phone, Name, Product, and Variant.");return}if(!n&&(!y.value||!c.value)){alert("Address and Division are required for Home Delivery.");return}const d={CustomerPhone:P.value,CustomerName:document.getElementById("custName").value,CustomerEmail:document.getElementById("custEmail")?document.getElementById("custEmail").value:"",Street:n?"Counter Sale - In Store":y.value,Divison:n?"Dhaka":c.value,City:n?"Dhaka":E.value,Thana:n?"":f.value,SubOffice:n?"":I.value,PostalCode:n?"1000":k.value||"0000",ProductVariantId:parseInt(i.value),OrderQuantity:parseInt(h.value),TargetCompanyId:parseInt(document.getElementById("targetCompanyId").value)||0,Confirmed:document.getElementById("confirmImmediately").checked},s=document.querySelector('input[name="__RequestVerificationToken"]')?.value;t.disabled=!0,t.textContent="Processing...",e&&(e.textContent=""),fetch("/order/place-direct",{method:"POST",headers:{"Content-Type":"application/json",RequestVerificationToken:s},body:JSON.stringify(d)}).then(o=>o.json()).then(o=>{if(o.success){let a=o.orderId;typeof o.orderId=="object"&&o.orderId!==null&&(a=o.orderId.OrderId||o.orderId.orderId),alert("Success! Order Created: "+a),window.location.reload()}else e&&(e.textContent="Error: "+o.message,e.className="mt-3 text-center small text-danger"),t.disabled=!1,t.textContent="Create Direct Order"}).catch(o=>{console.error(o),e&&(e.textContent="Network Error",e.className="mt-3 text-center small text-danger"),t.disabled=!1,t.textContent="Create Direct Order"})}),N()});
