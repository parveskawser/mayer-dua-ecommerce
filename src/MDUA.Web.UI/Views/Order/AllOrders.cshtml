@model List<MDUA.Entities.SalesOrderHeader>
@{
    ViewData["Title"] = "All Sales Orders";
    Layout = "_AdminLayout";
}

<!-- 1. Generate Anti-Forgery Token for JS to use -->
@Html.AntiForgeryToken()

<!-- Link to Scripts -->
@section Scripts {
    <script src="~/js/order-details.js"></script> <!-- THIS FIXES THE MODAL -->
    <script src="~/js/order-actions.js"></script> <!-- THIS HANDLES THE TOGGLE -->
}

<h2 class="fw-bold mb-3">Order List</h2>
<div class="text-muted small mb-4">Total Orders: @(Model?.Count() ?? 0)</div>

@if (ViewData["ErrorMessage"] != null)
{
    <div class="alert alert-danger" role="alert">
        @ViewData["ErrorMessage"]
    </div>
}

<div class="glass-card h-100 d-flex flex-column">
    <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle products-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Order Type</th>
                    <th>Order Date</th>
                    <th>Net Amount</th>
                    <th>Status</th>
                    <th>Confirmed</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    foreach (var order in Model.OrderByDescending(o => o.OrderDate))
                    {
                        string orderIdDisplay = order.SalesOrderId ?? order.Id.ToString();
                        string orderType = order.SalesChannelId == 1 ? "Online" : "Direct";

                        string dateStr = order.OrderDate != DateTime.MinValue ? order.OrderDate.ToString("MMM dd, yyyy hh:mm tt") : "N/A";
                        string createdStr = order.CreatedAt.ToString("MMM dd, yyyy hh:mm tt");
                        string updatedStr = order.UpdatedAt.HasValue ? order.UpdatedAt.Value.ToString("MMM dd, yyyy hh:mm tt") : "-";

                        // ✅ FIX: Map "Draft" (Database Value) to "Pending" (UI Display)
                        string displayStatus = order.Status == "Draft" ? "Pending" : order.Status;

                        string statusBadgeClass = "bg-secondary-subtle text-dark";
                        if (displayStatus == "Confirmed") { statusBadgeClass = "bg-success text-white"; }
                        else if (displayStatus == "Pending") { statusBadgeClass = "bg-warning text-dark"; }

                        <tr>
                            <td class="fw-medium">@orderIdDisplay</td>
                            <td>@orderType</td>
                            <td class="small">@FormatDate(order.OrderDate)</td>
                            <td>Tk. @FormatAmount(order.NetAmount)</td>

                            <td>
                                <!-- Display the Mapped Status, not the Raw DB Value -->
                                <span id="status-badge-@order.Id" class="badge @statusBadgeClass">
                                    @displayStatus
                                </span>
                            </td>

                            <td>
                                <div class="form-check form-switch">
                                    <input class="form-check-input confirm-toggle" type="checkbox" role="switch"
                                           id="toggle-@order.Id"
                                           data-id="@order.Id"
                                           @(order.Confirmed ? "checked" : "")>
                                    <label class="form-check-label small" for="toggle-@order.Id">
                                        @(order.Confirmed ? "Yes" : "No")
                                    </label>
                                </div>
                            </td>

                            <td class="text-end">
                                <!-- DATA ATTRIBUTES MUST MATCH JS EXACTLY -->
                                <!-- We pass the raw order.Status here just in case, or displayStatus if preferred for modal -->
                                <button type="button"
                                        class="btn btn-sm btn-outline-info"
                                        data-bs-toggle="modal"
                                        data-bs-target="#detailsModal"
                                        title="View Details"
                                        data-id="@orderIdDisplay"
                                        data-status="@displayStatus"
                                        data-type="@orderType"
                                        data-cust-id="@order.CompanyCustomerId"
                                        data-addr-id="@order.AddressId"
                                        data-total="@FormatAmount(order.TotalAmount)"
                                        data-discount="@FormatAmount(order.DiscountAmount)"
                                        data-net="@FormatAmount(order.NetAmount)"
                                        data-ip="@(order.IPAddress ?? "N/A")"
                                        data-session="@(order.SessionId ?? "N/A")"
                                        data-created-by="@(order.CreatedBy ?? "System")"
                                        data-created-at="@createdStr"
                                        data-updated-by="@(order.UpdatedBy ?? "-")"
                                        data-updated-at="@updatedStr">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="8"></line></svg>
                                </button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr><td colspan="7" class="text-center p-4 text-muted">No sales orders found.</td></tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Details Modal -->
<!-- It is cleaner to keep this OUTSIDE the loop and logic containers -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="detailsModalLabel">Order Details: <span id="m-id" class="fw-bold text-primary"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-uppercase text-muted small fw-bold">General Information</h6>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Order Type:</span> <span id="m-type" class="fw-medium"></span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Customer ID:</span> <span id="m-cust-id"></span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Address ID:</span> <span id="m-addr-id"></span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-uppercase text-muted small fw-bold">Status</h6>
                        <div class="p-3 bg-light rounded text-center">
                            <h4 id="m-status" class="mb-1"></h4>
                            <small class="text-muted">Current Order Status</small>
                        </div>
                    </div>
                </div>
                <hr />
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-uppercase text-muted small fw-bold">Financial Breakdown</h6>
                    </div>
                    <div class="col-md-4 text-center border-end">
                        <small class="d-block text-muted">Total Amount</small>
                        <span class="fs-5">Tk. <span id="m-total"></span></span>
                    </div>
                    <div class="col-md-4 text-center border-end text-danger">
                        <small class="d-block text-muted">Discount</small>
                        <span class="fs-5">- Tk. <span id="m-discount"></span></span>
                    </div>
                    <div class="col-md-4 text-center text-success">
                        <small class="d-block text-muted">Net Amount</small>
                        <span class="fs-4 fw-bold">Tk. <span id="m-net"></span></span>
                    </div>
                </div>
                <hr />
                <div class="row">
                    <div class="col-md-6 border-end">
                        <h6 class="text-uppercase text-muted small fw-bold">System / Audit</h6>
                        <dl class="row small mb-0">
                            <dt class="col-sm-4">Created By:</dt>
                            <dd class="col-sm-8" id="m-created-by"></dd>
                            <dt class="col-sm-4">Created At:</dt>
                            <dd class="col-sm-8" id="m-created-at"></dd>
                            <dt class="col-sm-4">Updated By:</dt>
                            <dd class="col-sm-8" id="m-updated-by"></dd>
                            <dt class="col-sm-4">Updated At:</dt>
                            <dd class="col-sm-8" id="m-updated-at"></dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-uppercase text-muted small fw-bold">Technical Data</h6>
                        <dl class="row small mb-0">
                            <dt class="col-sm-4">IP Address:</dt>
                            <dd class="col-sm-8 font-monospace" id="m-ip"></dd>
                            <dt class="col-sm-4">Session ID:</dt>
                            <dd class="col-sm-8 text-break" id="m-session"></dd>
                        </dl>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@functions {
    public string FormatDate(DateTime? date)
    {
        if (!date.HasValue || date.Value == DateTime.MinValue) return "N/A";
        return date.Value.ToString("MMM dd, yyyy");
    }

    public string FormatAmount(decimal? amount)
    {
        if (!amount.HasValue || amount.Value == 0M) return "0.00";
        return amount.Value.ToString("N2");
    }
}